/*! enmodal - v0.1.0 - 2018-02-15
* http://enmodal.co/
* Copyright (c) 2018 Jason Wright; Licensed MIT */

function handle_map_click(e){if(null!==enmodal.transit_interface.active_line&&"station"==enmodal.transit_interface.active_tool){var t=enmodal.transit_interface.pin_projection(e.latlng.lat,e.latlng.lng);t[0]?enmodal.transit_interface.get_station_pair_by_sp_id(t[2]).add_pin(t[1].x,t[1].y):enmodal.transit_interface.add_new_station(e.latlng.lat,e.latlng.lng)}null===enmodal.transit_interface.active_line&&"station"==enmodal.transit_interface.active_tool&&L.popup().setLatLng(e.latlng).setContent("Create a line to start building").openOn(enmodal.leaflet_map),"transfer"==enmodal.transit_interface.active_tool&&(enmodal.transit_interface.active_tool="station",enmodal.transit_interface.preview_clear())}function set_basemap_style(e){enmodal.transit_interface.basemap&&_leaflet_map.removeLayer(enmodal.transit_interface.basemap),enmodal.transit_interface.basemap=L.esri.basemapLayer(e),_leaflet_map.addLayer(enmodal.transit_interface.basemap);var t={DarkGray:{opacity:1,background_color:"#474749"},Gray:{opacity:1,background_color:"#e8e8e8"},Imagery:{opacity:.4,background_color:"#474749"},Oceans:{opacity:1,background_color:"#f1eedd"}};if(e in t){var s=t[e];$("#map.leaflet-container").css("background-color",s.background_color),_leaflet_map.getPane("tilePane").style.opacity=s.opacity}}function set_basemap_labels(e,t){enmodal.transit_interface.basemapLabels&&_leaflet_map.removeLayer(enmodal.transit_interface.basemapLabels),t&&(enmodal.transit_interface.basemapLabels=L.esri.basemapLayer(e+"Labels"),_leaflet_map.addLayer(enmodal.transit_interface.basemapLabels))}function init_leaflet_map(){var e=L.map("map",{fullscreenControl:!0,attributionControl:!1}).setView([40.713,-74.006],START_ZOOM);return e.on("click",handle_map_click),e}function init_document(){$(document).on("click",".station-delete",delete_station_event),$(document).on("click",".station-transfer",transfer_station_event),$(document).on("click",".station-build",build_to_station_event),$(document).on("click",".subway-deletable",function(){var e=parseInt($(this).attr("transit-line-id")),t=parseInt($(this).attr("transit-station-id"));enmodal.transit_interface.remove_line_from_station(t,e)}),$(document).on("click",".station-name",function(){if(0===$(this).has("input").length){var e=$(this).text(),t=$(this);$(this).text(""),$('<input type="text" class="station-name-edit enm-editable"></textarea>').appendTo($(this)).val(e).select().blur(function(){var e=$(this).val();$(this).parent().html(e+'  <i class="fa fa-pencil" style="margin-left: 5px;" aria-hidden="true"></i>').find("input").remove();var s=t.attr("id").replace("station-",""),i=enmodal.transit_interface.active_service.get_station_by_id(s);i.name=e,enmodal.sidebar.update_line_diagram(),enmodal.transit_interface.sync_station_info(i),enmodal.transit_interface.get_station_marker_by_station(i).update_tooltip()}).keyup(function(e){13==e.keyCode&&this.blur()})}}),$(document).on("click",".subway-clickable",function(){return line_select_click_handler($(this)),!1}),$(document).on("click",".route-diagram-stop-info",function(){var e=$(this).attr("id").replace("station-",""),t=enmodal.transit_map.get_station_by_id(e),s=enmodal.transit_interface.get_station_marker_by_station(t);s.generate_popup(),s.marker.openPopup(),enmodal.leaflet_map.panTo(s.marker.getLatLng())}),$("#custom-line-name").keyup(function(){enmodal.sidebar.update_line_editor(),enmodal.sidebar.line_editor_save()}),$("#line-selector-new").click(function(){enmodal.sidebar.line_selector_new()}),$(document).on("click",".line-selector-option",function(e){enmodal.sidebar.update_line_selector(parseInt(e.currentTarget.getAttribute("transit-line-id")))}),$("#custom-service-name").keyup(function(){enmodal.sidebar.service_editor_save()}),$("#service-selector-new").click(function(){enmodal.sidebar.service_selector_new()}),SERVICE_MODES_ENABLED&&$(".service-mode-button").click(function(){var e=$(this).attr("transit-service-mode");enmodal.transit_interface.active_service.mode=e,enmodal.sidebar.update_service_selector(enmodal.transit_interface.active_service.sid,!0)}),$(document).on("click",".service-selector-option",function(e){enmodal.sidebar.update_service_selector(parseInt(e.currentTarget.getAttribute("transit-service-id")),!0)}),$(".subway-hidden").hide(),$("#custom-lines").hide(),$("#game-start-scratch").click(function(){$("#starter-city-picker").hide(),$("#starter").hide(),$("#options").show()}),$("#city-picker-input").autocomplete({source:function(e,t){if(is_latlng(e.term)){var s=get_latlng(e.term);enmodal.leaflet_map.panTo(L.latLng(s[0],s[1]))}else $.ajax({url:"http://search.mapzen.com/v1/autocomplete?api_key=mapzen-t6h4cff&layers=locality&text="+e.term,dataType:"json",success:function(e){t($.map(e.features,function(e){if("USA"==e.properties.country_a)return{label:e.properties.locality+", "+e.properties.region_a,value:e.geometry}}))}})},select:function(e,t){return $("#city-picker-input").val(t.item.label),enmodal.transit_interface.map.panTo(L.latLng(t.item.value.coordinates[1],t.item.value.coordinates[0])),!1},minLength:3}),$("#custom-line-options #color-picker-bg").spectrum({color:DEFAULT_LINE_BG,showInput:!0,className:"full-spectrum",showInitial:!0,maxSelectionSize:10,preferredFormat:"hex",change:function(e){enmodal.sidebar.update_line_editor(),enmodal.sidebar.line_editor_save()}}),$("#custom-line-options #color-picker-fg").spectrum({color:DEFAULT_LINE_FG,showInput:!0,className:"full-spectrum",showInitial:!0,maxSelectionSize:10,preferredFormat:"hex",change:function(e){enmodal.sidebar.update_line_editor(),enmodal.sidebar.line_editor_save()}}),null!==enmodal.transit_interface.active_line&&enmodal.sidebar.refresh_line_editor(),$("#tool-station").click(function(e){"station"!=enmodal.transit_interface.active_tool&&(enmodal.transit_interface.layers.preview.clearLayers(),enmodal.transit_interface.active_tool="station")}),$("#tool-data").click(function(e){"data"!=enmodal.transit_interface.active_tool&&(enmodal.transit_interface.layers.preview.clearLayers(),enmodal.transit_interface.active_tool="data")}),$(".data-layer-selector").click(function(e){$(this).hasClass("data-layer-selected")?(enmodal.data.active=null,$("#scale").hide(),$(".data-layer-selector").removeClass("data-layer-selected"),enmodal.transit_interface.layers.data.clearLayers()):($(".data-layer-selector").removeClass("data-layer-selected"),$(this).addClass("data-layer-selected"),"data-layer-population"==$(this).attr("id")&&(enmodal.data.hide_layers(),enmodal.data.draw_layer_population(!0)),"data-layer-employment"==$(this).attr("id")&&(enmodal.data.hide_layers(),enmodal.data.draw_layer_employment(!0)),"data-layer-ridership"==$(this).attr("id")&&(enmodal.data.hide_layers(),enmodal.data.draw_layer_ridership()))}),$("#tool-save").click(function(e){session_save()}),$("#tool-share").click(function(e){$("#starter-share").show(),$("#starter").show()}),$("#share-ok").click(function(e){$("#starter-share").hide(),$("#starter").hide()}),$(document).on("click","#map-title-inner",function(){if(0===$(this).has("input").length){var e=$(this).text().trim();$(this);$(this).text(""),$('<input type="text" class="map-title-edit enm-editable"></input>').appendTo($(this)).val(e).select().blur(function(){var e=$(this).val();$(this).parent().html(e+'  <i class="fa fa-pencil" style="margin-left: 5px;" aria-hidden="true"></i>').find("input").remove();var t=$.param({i:enmodal.session_id,name:e});$.ajax({url:"map_name?"+t,async:!1,dataType:"json",success:function(t,s){enmodal.map_name=e}})}).keyup(function(e){13==e.keyCode&&this.blur()})}}),$(document).keydown(function(e){console.log("keydown"),89===e.which&&e.ctrlKey?(console.log("ctrl+y"),redo()):90===e.which&&e.ctrlKey&&(console.log("ctrl+z"),undo())}),new Clipboard(".share-link-copy-button")}function save_svg(e,t){var s=SVG("svg-drawing").size(OUTPUT_HEIGHT_PX,OUTPUT_WIDTH_PX),i=$("div.leaflet-overlay-pane svg").html(),a=$("div.leaflet-stationMarker-pane svg").html();s.svg(i),s.svg(a);btoa(s.svg());canvg(document.getElementById("canvas"),s.svg());var n=document.getElementById("canvas").toDataURL("image/png");$("#svg-drawing").empty();var r=e.getContext("2d"),o=new Image,l=_leaflet_map.getPixelBounds(),_=_leaflet_map.getPixelOrigin(),d=_.x-l.min.x,c=_.y-l.min.y;o.onload=function(){r.drawImage(o,d,c),t(r)},o.src=n}function create_image(e){_leaflet_map.getCenter(),_leaflet_map.getZoom();$("#map").css("height",OUTPUT_HEIGHT_PX),$("#map").css("width",OUTPUT_WIDTH_PX),_leaflet_map.invalidateSize(),enmodal.transit_interface.preview_clear();var t=enmodal.transit_map.geographic_bounds();null!==t&&_leaflet_map.fitBounds(t),$("#map").hide(),setTimeout(function(){leafletImage(_leaflet_map,function(t,s){save_svg(s,function(t){t.fillStyle="rgba(0,0,0,0.75)",t.fillRect(0,1964,2e3,36),t.font="12px sans-serif",t.fillStyle="white",null!==enmodal.map_name&&t.fillText(enmodal.map_name,12,1988),t.textAlign="right",t.fillText("created with enmodal -- http://enmodal.co",1988,1988),e(s)})})},1e3)}function save_image(){create_image(function(e){$('<a href="'+e.toDataURL("image/png")+'" download="enmodal-'+enmodal.session_id+'.png" style="display:none;"></a>').appendTo("body")[0].click(),e.getContext("2d").clearRect(0,0,e.width,e.height),document.getElementById("canvas").getContext("2d").clearRect(0,0,e.width,e.height)})}function save_pdf(e){create_image(function(t){var s=new jsPDF({orientation:"landscape",unit:"pt",format:[OUTPUT_WIDTH_PT,OUTPUT_HEIGHT_PT]});s.addImage(t.toDataURL("image/jpeg",1),"JPEG",0,0),s.save("enmodal-"+enmodal.session_id+".pdf"),t.getContext("2d").clearRect(0,0,t.width,t.height),document.getElementById("canvas").getContext("2d").clearRect(0,0,t.width,t.height),$("#map").css("height",""),$("#map").css("width",""),$("#map").show(),_leaflet_map.invalidateSize(),e()})}function sortNumber(e,t){return e-t}function push_undo_buffer(){_undo_index<_undo_buffer.length-1&&_undo_buffer.splice(_undo_index,_undo_buffer.length-_undo_index-1),_undo_buffer.length==UNDO_BUFFER_SIZE&&_undo_buffer.splice(0,1);var e=enmodal.transit_map.to_json(),t=JSON.parse(e);t.settings=enmodal.transit_interface.settings();var s=JSON.stringify(t);_undo_buffer.push(s),_undo_index=_undo_buffer.length-1}function undo(){if(null===_undo_index&&(_undo_index=_undo_buffer.length),!(_undo_index<=0)){var e=_undo_buffer[_undo_index-=1];handle_map_data(JSON.parse(e))}}function redo(){if(null!==_undo_index&&!(_undo_index>=_undo_buffer.length-1)){var e=_undo_buffer[_undo_index+=1];handle_map_data(JSON.parse(e))}}function check_server_error(e){"error"in e&&(console.log(e.error),"Invalid session"==e.error&&(app.modal="session-expired",setTimeout(function(){location.reload()},5e3)))}function delete_station_event(e){var t=parseInt($(this).attr("transit-station-id"));enmodal.transit_interface.remove_station(t,!1)}function transfer_station_event(e){var t=$(this).attr("id").replace("transfer-","");enmodal.transit_interface.active_transfer_station=enmodal.transit_interface.active_service.get_station_by_id(t),enmodal.transit_interface.active_tool="transfer"}function build_to_station_event(e){var t=$(this).attr("id");enmodal.transit_interface.add_stop_to_station(t)}function session_new(){$.ajax({url:"session",async:!1,dataType:"json",success:function(e,t){enmodal.public_key=e.public_key,enmodal.session_id=e.private_key,window.history.pushState("","","?id="+enmodal.session_id),enmodal.sharing.update(e.public_key,e.private_key)}});var e=new Service("MTA");e.mode="heavy_rail",enmodal.transit_map.add_service(e),enmodal.transit_interface.active_service=e,enmodal.sidebar.update_service_selector(enmodal.transit_interface.active_service.sid),enmodal.sidebar.refresh_service_editor();var t=$.param({i:enmodal.session_id,service_id:e.sid,name:e.name});$.ajax({url:"service_add?"+t,async:!1,dataType:"json",success:function(e,t){}})}function handle_map_data(e){if(console.log(e),enmodal.transit_interface.station_pairs=[],enmodal.transit_map.sid=e.sid,enmodal.transit_map.from_json(e),0===enmodal.transit_map.services.length)session_new();else{enmodal.transit_interface.active_service=enmodal.transit_map.primary_service(),enmodal.transit_interface.active_line=enmodal.transit_map.primary_service().lines[0],enmodal.sidebar.update_service_selector(enmodal.transit_interface.active_service.sid,!0),enmodal.sidebar.refresh_service_editor(),enmodal.sidebar.update_line_selector(enmodal.transit_interface.active_line.sid),enmodal.sidebar.update_line_editor(),enmodal.sidebar.refresh_line_editor(),enmodal.sidebar.update_line_diagram();for(var t=e.settings,s=0;s<t.station_pairs.length;s++){var i=t.station_pairs[s],a=enmodal.transit_map.get_station_by_id(i.station_ids[0]),n=enmodal.transit_map.get_station_by_id(i.station_ids[1]),r=enmodal.transit_interface.get_station_pair(a,n);if(null!==r)for(var o=0;o<i.pins.length;o++)r[0].add_pin(i.pins[o].location[0],i.pins[o].location[1])}enmodal.transit_interface.draw_transfers();var l=enmodal.transit_map.geographic_bounds();null!==l&&enmodal.leaflet_map.fitBounds(l),enmodal.data.get_ridership()}}function session_load(){var e=$.param({i:enmodal.session_id});$.ajax({url:"session_load?"+e,async:!1,success:function(e,t){var s=JSON.parse(e);void 0!==s.error?session_new():(handle_map_data(JSON.parse(s.data)),window.history.pushState("","","?id="+enmodal.session_id),enmodal.public_key=s.public_key,enmodal.session_id=s.private_key,null!==s.title&&($("#map-title-inner").html(s.title+'  <i class="fa fa-pencil" style="margin-left: 5px;" aria-hidden="true"></i>'),enmodal.map_name=s.title),$("#starter-city-picker").hide(),$("#starter").hide(),$("#options").show())}})}function session_save(){var e=$.param({i:enmodal.session_id});$("#tool-save").html('<i class="fa fa-spinner fa-spin fa-1x fa-fw"></i>'),$.ajax({url:"session_push?"+e,async:!0,type:"POST",data:LZString.compressToUTF16(session_json()),dataType:"text",success:function(e,t){var s=$.param({i:enmodal.session_id});$.ajax({url:"session_save?"+s,async:!0,dataType:"json",success:function(e,t){"OK"==e.result?($("#tool-save").html("Save"),$("#tool-save").attr("data-balloon","Saved!"),$("#tool-save").attr("data-balloon-visible",""),setTimeout(function(){$("#tool-save").removeAttr("data-balloon"),$("#tool-save").removeAttr("data-balloon-visible")},3e3)):"Anonymous user"==e.message?($("#tool-save").html("Save"),$("#tool-save").attr("data-balloon","You must be logged in to save."),$("#tool-save").attr("data-balloon-visible",""),setTimeout(function(){$("#tool-save").removeAttr("data-balloon"),$("#tool-save").removeAttr("data-balloon-visible")},3e3)):($("#tool-save").html("Save"),$("#tool-save").attr("data-balloon","Error saving. Please try again later."),$("#tool-save").attr("data-balloon-visible",""),setTimeout(function(){$("#tool-save").removeAttr("data-balloon"),$("#tool-save").removeAttr("data-balloon-visible")},3e3))}})}})}function session_json(){var e={map:enmodal.transit_map,settings:enmodal.transit_interface.settings()};return JSON.stringify(e)}function get_url_parameter(e){var t={};return window.location.href.replace(location.hash,"").replace(/[?&]+([^=&]+)=?([^&]*)?/gi,function(e,s,i){t[s]=void 0!==i?i:""}),e?t[e]?t[e].replace(/\#$/,""):null:t}function num_unique_colors(e){for(var t=0,s=[],i=0;i<e.length;i++)-1==s.indexOf(e[i].color_bg)&&(s.push(e[i].color_bg),t+=1);return t}function station_distance(e,t){var s={type:"Feature",properties:{},geometry:{type:"Point",coordinates:[e.location[1],e.location[0]]}},i={type:"Feature",properties:{},geometry:{type:"Point",coordinates:[t.location[1],t.location[0]]}};return turf.distance(s,i,"miles")}function is_latlng(e){return/^(\-)?[0-9]{0,3}.[0-9]*,(\ )?(\-)?[0-9]{0,3}.[0-9]*$/.test(e)}function get_latlng(e){var t=e.split(",");return[parseFloat(t[0]),parseFloat(t[1])]}function save_json(){var e=session_json(),t=new Blob([e],{type:"text/plain;charset=utf-8"});saveAs(t,"enmodal.json")}var _id_factory,_leaflet_map,enmodal,_undo_buffer=[],_undo_index=null;$(function(){_id_factory=new IdFactory,_leaflet_map=init_leaflet_map(),enmodal={public_key:null,session_id:get_url_parameter("id"),sidebar:new Sidebar,sharing:new Sharing,leaflet_map:_leaflet_map,transit_map:new Map,transit_interface:new TransitUI(_leaflet_map),map_name:null,data:new DataLayers,id_factory:_id_factory},$("a#share").click(function(){enmodal.sharing.update(enmodal.public_key,enmodal.session_id)}),set_basemap_style("DarkGray"),set_basemap_labels("DarkGray",!0),init_document(),null!==enmodal.session_id?session_load():"/view"!=window.location.pathname&&session_new(),push_undo_buffer()});class Pin{constructor(e){this.location=e,this.sid=_id_factory.id(),this.marker=null}draw(){enmodal.transit_interface.layers.active.line_paths.addLayer(this.marker)}undraw(){enmodal.transit_interface.layers.active.line_paths.removeLayer(this.marker)}toJSON(){return{sid:this.sid,location:this.location}}}class SplineSegment{constructor(e,t){this.controls=e,this.centers=t}}class LineSplineSegment{constructor(e,t,s){this.line=e,this.spline_segments=t,this.reverse=s}}class BezierControlPoint{constructor(e,t){this.lat=e,this.lng=t}}class BezierCenter{constructor(e,t){this.lat=e,this.lng=t}}class DataLayers{constructor(){this.active=null,this.hexagon_bounds=null,this.hexagon_zoom=null}draw_layer_population(e){this.active="population",this.get_hexagons(e)}draw_layer_employment(e){this.active="employment",this.get_hexagons(e)}draw_layer_ridership(){for(var e,t,s=-1,i=0,a=0;a<enmodal.transit_interface.active_service.stations.length;a++)(t=(e=enmodal.transit_interface.active_service.stations[a]).ridership)>i&&(i=t),(t<s||-1==s)&&(s=t);for(a=0;a<enmodal.transit_interface.active_service.stations.length;a++){var n=39*((t=(e=enmodal.transit_interface.active_service.stations[a]).ridership)-s)/(i-s)+1;enmodal.transit_interface.layers.data.addLayer(L.circleMarker(e.location,{color:"red",radius:n}))}for($("#scale-boxes").empty(),a=0;a<10;a++)$("#scale-boxes").append('<div class="scale-box"><div class="scale-inner" style="width: '+(2*(a+1)).toString()+"px; height: "+(2*(a+1)).toString()+"px; top: "+(20-(a+1)).toString()+'px;"></div>');$("#scale-low").text(Math.round(s)),$("#scale-mid").text(Math.round((i-s)/2+s)),$("#scale-high").text(Math.round(i)),$("#scale-units").html("weekday riders"),$("#scale").show()}draw_active_layer(e){"population"==this.active&&this.draw_layer_population(e),"employment"==this.active&&this.draw_layer_employment(e),"ridership"==this.active&&this.draw_layer_ridership()}get_ridership(){var e=$.param({i:enmodal.session_id});$.ajax({url:"transit_model?"+e,async:ASYNC_REQUIRED,dataType:"json",success:function(e,t){for(var s in e){var i=e[s],a=enmodal.transit_interface.active_service.get_station_by_id(parseInt(s));null!==a&&(a.ridership=i,$("#stationriders-"+a.sid.toString()).text(Math.round(a.ridership).toString()))}}})}quantiles(e,t,s){for(var i=[],a=0;a<e.features.length;a++)i.push(e.features[a].properties[s]);i.sort(sortNumber);var n=[],r=i.length-1;r-=Math.round(i.length/t);for(var o=0;o<=t;o++)n.push(i[r]),(r-=Math.round(i.length/t))<0&&(r=0);return n}population_color(e,t,s){for(var i=t.length-1,a=0;a<i;a++)if(e>=t[a])return s(a/i).hex();return s[i-1]}get_hexagons(e){var t=enmodal.leaflet_map.getBounds(),s=t.pad(.5),i=!0;null!==this.hexagon_bounds&&null!==this.hexagon_zoom&&this.hexagon_bounds.contains(t)&&enmodal.transit_interface.map.getZoom()==this.hexagon_zoom&&(i=!1),enmodal.transit_interface.map.getZoom()<MIN_ZOOM&&(i=!1);enmodal.transit_interface.data_layer_request_num;if(e&&(i=!0),i){this.hexagon_bounds=s,this.hexagon_zoom=enmodal.transit_interface.map.getZoom();var a=$.param({i:enmodal.session_id,lat_min:s.getSouth(),lat_max:s.getNorth(),lng_min:s.getWest(),lng_max:s.getEast()});$.ajax({url:"get_hexagons?"+a,async:ASYNC_REQUIRED,dataType:"text",success:function(e,t){var s=JSON.parse(e),i=enmodal.data.quantiles(s,8,enmodal.data.active),a=HEXAGON_SCALES[enmodal.data.active];$("#scale-boxes").empty();for(var n=0;n<8;n++)$("#scale-boxes").append('<div class="scale-box" style="background-color: '+a((8-n)/8).hex()+' "></div>');$("#scale-low").text("0"),$("#scale-mid").text(Math.round(i[Math.round(3.5)]/DGGRID_AREA).toString()),$("#scale-high").text(Math.round(i[0]/DGGRID_AREA).toString()),$("#scale-units").html(HEXAGON_UNITS[enmodal.data.active]),$("#scale").show(),enmodal.transit_interface.layers.data.clearLayers(),enmodal.leaflet_map.getZoom()<14?enmodal.transit_interface.layers.data.addLayer(L.vectorGrid.slicer(s,{vectorTileLayerStyles:{sliced:function(e,t){var s=0;return"population"==enmodal.data.active&&(s=e.population),"employment"==enmodal.data.active&&(s=e.employment),{fillColor:enmodal.data.population_color(s,i,a),fill:!0,weight:0,opacity:1,color:"white",fillOpacity:.35}}}})):enmodal.transit_interface.layers.data.addLayer(L.geoJson(s,{style:function(e){var t=0;return"population"==enmodal.data.active&&(t=e.properties.population),"employment"==enmodal.data.active&&(t=e.properties.employment),{fillColor:enmodal.data.population_color(t,i,a),weight:0,opacity:1,color:"white",fillOpacity:.35}}})),enmodal.transit_interface.layers.active.line_paths.bringToFront(),enmodal.leaflet_map.setMinZoom(MIN_ZOOM)}})}}hide_layers(){this.active=null,enmodal.transit_interface.layers.data.clearLayers()}}Vue.component("modal-city-picker",{template:"#template-modal-city-picker",props:{visible:{type:Boolean,default:!0}}}),Vue.component("modal-pro-gate",{template:"#template-modal-pro-gate",props:{visible:{type:Boolean,default:!0}}}),Vue.component("modal-exporting-pdf",{template:"#template-modal-exporting-pdf",props:{visible:{type:Boolean,default:!0}}}),Vue.component("modal-sharing",{template:"#template-modal-sharing",props:{visible:{type:Boolean,default:!0}}}),Vue.component("modal-session-expired",{template:"#template-modal-session-expired",props:{visible:{type:Boolean,default:!0}}}),Vue.component("collapse-caret",{template:"#template-collapse-caret",props:{visible:{type:Boolean,default:!0},dataTargetProp:"",dataTargetValue:""},methods:{reset(){this.collapsed=!1},collapse(){console.log(this.dataTargetProp),console.log(this.dataTargetValue),this.collapsed?(this.collapsed=!1,$("["+this.dataTargetProp+"='"+this.dataTargetValue+"']").show()):(this.collapsed=!0,$("["+this.dataTargetProp+"='"+this.dataTargetValue+"']").hide())}},mounted(){this.reset()}}),Vue.component("button-import-gtfs",{template:"#template-button-import-gtfs",props:{visible:{type:Boolean,default:!0}}}),Vue.component("button-import-json",{template:"#template-button-import-json",props:{visible:{type:Boolean,default:!0}}}),Vue.component("button-sharing",{template:"#template-button-sharing",props:{visible:{type:Boolean,default:!0}}}),Vue.component("button-export-pdf",{template:"#template-button-export-pdf",props:{visible:{type:Boolean,default:!0}},methods:{exportPdf:function(){app.modal="exporting-pdf",save_pdf(function(){app.modal="none"})}}}),Vue.component("button-export-json",{template:"#template-button-export-json",props:{visible:{type:Boolean,default:!0}},methods:{exportJson:function(){save_json(function(){})}}}),Vue.component("button-basemap-style",{template:"#template-button-basemap-style",props:{visible:{type:Boolean,default:!0}},methods:{setBasemap:function(e){e!=app.basemapStyle&&(set_basemap_style(e),set_basemap_labels(e,app.basemapLabels),app.basemapStyle=e)}}}),Vue.component("button-basemap-labels",{template:"#template-button-basemap-labels",props:{visible:{type:Boolean,default:!0}},methods:{setLabels:function(e){e!=app.basemapLabels&&(set_basemap_labels(app.basemapStyle,e),app.basemapLabels=e)}}});const STATUS_INITIAL=0,STATUS_SAVING=1,STATUS_ANALYZING=2,STATUS_SUCCESS=3,STATUS_FAILED=4,STATUS_IMPORTING=5;Vue.component("modal-gtfs-import",{template:"#template-modal-gtfs-import",props:{visible:{type:Boolean,default:!0},uploadFieldName:"gtfs",fileCount:0},computed:{isInitial:()=>0===app.upload_status,isSaving:()=>1===app.upload_status,isAnalyzing:()=>2===app.upload_status,isSuccess:()=>3===app.upload_status,isFailed:()=>4===app.upload_status,isImporting:()=>5===app.upload_status,gtfsImportMap:()=>app.gtfsImportMap},methods:{reset:function(){this.uploadedFiles=[],this.uploadError=null,this.gtfsImportMap=null},upload:function(e,t,s){var i=$.param({i:enmodal.session_id});$.ajax({url:"gtfs_upload?"+i,async:!0,data:e,cache:!1,contentType:!1,processData:!1,method:"POST",success:function(e){t([])}})},save:function(e){app.upload_status=1,this.upload(e,function(e){this.uploadedFiles=[].concat(e),app.upload_status=2;var t=$.param({i:enmodal.session_id});$.ajax({url:"gtfs_analyze?"+t,async:!0,dataType:"json",success:function(e,t){app.upload_status=3,app.gtfsImportMap=e,console.log(e)}})},function(e){this.uploadError=e.response,app.upload_status=4})},filesChange:function(e,t){const s=new FormData;t.length&&(Array.from(Array(t.length).keys()).map(i=>{s.append(e,t[i],t[i].name)}),this.save(s))},toggleAgency:function(e){var t=$("input:checkbox.agency[data-agency-id='"+e+"']").prop("checked");$("input:checkbox.route[data-agency-id='"+e+"']").prop("checked",t)},selectAll:function(){console.log("select all"),$("input:checkbox.agency").prop("checked",!0),$("input:checkbox.route").prop("checked",!0)},selectNone:function(){console.log("select none"),$("input:checkbox.agency").prop("checked",!1),$("input:checkbox.route").prop("checked",!1)},start:function(){console.log("importing"),app.upload_status=5;var e=[],t=[];$("input:checkbox.route").each(function(){if($(this).prop("checked")){var s=$(this).attr("data-agency-id"),i=$(this).attr("data-route-id");-1==e.indexOf(s)&&e.push(s),-1==t.indexOf(i)&&t.push(i)}}),console.log(e),console.log(t);var s=$.param({i:enmodal.session_id}),i={services:e,lines:t};$.ajax({url:"gtfs_import?"+s,async:!0,data:JSON.stringify(i),dataType:"json",contentType:"application/json",method:"POST",success:function(e,t){app.modal="none",handle_map_data(e)}})}},mounted(){this.reset()}}),Vue.component("modal-json-import",{template:"#template-modal-json-import",props:{visible:{type:Boolean,default:!0},uploadFieldName:"json",fileCount:0},computed:{isInitial:()=>0===app.json_import_status,isSaving:()=>1===app.json_import_status,isSuccess:()=>3===app.json_import_status,isFailed:()=>4===app.json_import_status},methods:{reset:function(){this.uploadedFiles=[],this.uploadError=null,this.jsonImportMap=null},upload:function(e,t,s){},save:function(e){console.log("importing"),app.json_import_status=1;var t=new FileReader;t.onload=function(e){var t=JSON.parse(e.target.result),s=t.map;s.settings=t.settings,handle_map_data(s),app.json_import_status=0,app.modal="none"};t.readAsText(e)},filesChange:function(e,t){new FormData;t.length&&this.save(t[0])}},mounted(){this.reset()}});var app=new Vue({el:"#app",data:{modal:"city-picker",upload_status:0,json_import_status:0,gtfsImportMap:null,basemapStyle:"DarkGray",basemapLabels:!0}});class LinePath{constructor(){this.raw_edge_paths=[],this.edge_paths=[]}get_path_for_edge(e){for(var t=0;t<this.edge_paths.length;t++)if(this.edge_paths[t].edge_id==e.sid)return this.edge_paths[t];return null}get_raw_path_for_edge(e){for(var t=0;t<this.raw_edge_paths.length;t++)if(this.raw_edge_paths[t].edge_id==e.sid)return this.raw_edge_paths[t];return null}}class EdgePath{constructor(e,t,s,i,a,n){this.edge_id=e,this.stop_points=t,this.control_points=s,this.custom_control_points=[],this.offset=i,this.color=a,this.opacity=n,this.track_width=TRACK_WIDTH,this.path=this.generate_path(this.color,this.opacity)}generate_path(e,t){var s;if(0===this.control_points.length)s=L.polyline([L.latLng(this.stop_points[0][0],this.stop_points[0][1]),L.latLng(this.stop_points[1][0],this.stop_points[1][1])],{weight:this.track_width,color:e,opacity:t});else if(0===this.control_points[0].length)s=L.polyline([L.latLng(this.stop_points[0][0],this.stop_points[0][1]),L.latLng(this.stop_points[1][0],this.stop_points[1][1])],{weight:this.track_width,color:e,opacity:t});else{for(var i=["M",[this.stop_points[0][0],this.stop_points[0][1]]],a=0;a<this.control_points.length;a++){var n=["C",[this.control_points[a][0].lng,this.control_points[a][0].lat],[this.control_points[a][1].lng,this.control_points[a][1].lat],[this.stop_points[a+1][0],this.stop_points[a+1][1]]];i.push.apply(i,n)}var r={color:e,weight:this.track_width,opacity:t,fill:!1,smoothFactor:1,offset:this.offset*(this.track_width/2),clickable:!1,"pointer-events":"none",className:"no-hover"};s=L.curve(i,r)}return s}regenerate_path(){this.path=this.generate_path(this.color,this.opacity)}}class LineColor{constructor(e,t,s){this.r=e,this.g=t,this.b=s,this.fr=255,this.fg=255,this.fb=255,e+t+s>382.5&&(this.fr=0,this.fg=0,this.fb=0)}bg_hex(){return"#"+("0"+this.r.toString(16).toUpperCase()).slice(-2)+("0"+this.g.toString(16).toUpperCase()).slice(-2)+("0"+this.b.toString(16).toUpperCase()).slice(-2)}fg_hex(){return"#"+("0"+this.fr.toString(16).toUpperCase()).slice(-2)+("0"+this.fg.toString(16).toUpperCase()).slice(-2)+("0"+this.fb.toString(16).toUpperCase()).slice(-2)}}class Hexagon{constructor(e,t,s,i){this.sid=e,this.geo=t,this.color=s,this.opacity=i,this.style=this.generate_style(),this.poly=this.generate_poly()}generate_poly(){return L.geoJSON(this.geo,{style:this.style})}update_poly(){this.poly=this.generate_poly()}generate_style(){return{color:this.color,stroke:!1,fillOpacity:this.opacity}}update_style(){this.style=this.generate_style(),this.poly.setStyle(this.style)}draw(){NS_interface.data_layer.addLayer(this.poly)}}var OUTPUT_WIDTH_PX=2e3,OUTPUT_HEIGHT_PX=2e3,OUTPUT_DPI=72,OUTPUT_WIDTH_PT=.75*OUTPUT_WIDTH_PX,OUTPUT_HEIGHT_PT=.75*OUTPUT_HEIGHT_PX;class TransitUI{constructor(e){this.active_service=null,this.active_line=null,this.station_markers=[],this.line_paths={},this.station_pairs=[],this.preview_paths=[],this.map=e,this.active_tool="station",this.data_layer_request_num=0,this.preview_paths_enabled=!0,this.nearest_station_to_mouse=null,this.station_for_bezier_edits=null,this.moving_station_marker=null,this.station_to_merge=null,this.dragging_pin=!1,this.station_pair_id_move_count_map={},this.preview_line_pin_marker=null,this.active_transfer_station=null,this.pane_station_markers=this.map.createPane("stationMarkerPane"),this.pane_station_markers=this.map.createPane("inactiveStationMarkerPane"),this.layers={active:{line_paths:L.featureGroup(),transfers:L.featureGroup(),station_markers:L.featureGroup({pane:"stationMarkerPane"})},inactive:{line_paths:L.featureGroup(),transfers:L.featureGroup(),station_markers:L.featureGroup({pane:"inactiveStationMarkerPane"})},basemap:null,basemapLabels:null,preview:L.featureGroup(),data:L.featureGroup()},this.hexagons={},this.chroma_scale=chroma.scale("YlGnBu"),this.map.addLayer(this.layers.data),this.map.addLayer(this.layers.active.line_paths),this.map.addLayer(this.layers.active.transfers),this.map.addLayer(this.layers.active.station_markers),this.map.addLayer(this.layers.inactive.line_paths),this.map.addLayer(this.layers.inactive.transfers),this.map.addLayer(this.layers.inactive.station_markers),this.map.addLayer(this.layers.preview),this.map.on("mouseup",()=>{if(this.map.dragging.enable(),this.map.removeEventListener("mousemove"),this.preview_paths_enabled=!0,this.map.on("mousemove",function(e){enmodal.transit_interface.preview_handler(e)}),null!==this.moving_station_marker){if(null!==this.station_to_merge?(this.merge_stations(this.moving_station_marker.station,this.station_to_merge),this.station_to_merge=null):(this.update_station_info(this.moving_station_marker.station),this.moving_station_marker.update_tooltip(),this.moving_station_marker.generate_popup(),this.moving_station_marker.marker.openPopup()),"bus"==this.active_service.mode)for(var e=this.active_service.station_lines(this.moving_station_marker.station),t=0;t<e.length;t++){for(var s=enmodal.transit_interface.get_station_pairs_for_line(e[t]),i=0;i<s.length;i++)s[i].undraw_paths(),s[i].paths=[],s[i].street_path_is_valid=!1;this.draw_line(e[t],!1,!0,this.layers.active.line_paths,!0,this.active_service)}this.moving_station_marker=null,this.purge_bad_transfers(),enmodal.sidebar.update_line_diagram(),push_undo_buffer()}}),this.map.on("mousemove",function(e){enmodal.transit_interface.preview_handler(e)}),this.map.on("moveend",function(e){enmodal.data.draw_active_layer(!1)})}draw_map(){this.layers.active.station_markers.clearLayers(),this.layers.active.line_paths.clearLayers(),this.layers.inactive.station_markers.clearLayers(),this.layers.inactive.line_paths.clearLayers(),this.station_markers=[],this.purge_station_pairs();for(var e=0;e<enmodal.transit_map.services.length;e++){var t,s=enmodal.transit_map.services[e];t=s==enmodal.transit_interface.active_service?enmodal.transit_interface.layers.active:enmodal.transit_interface.layers.inactive,enmodal.transit_interface.draw_service(s,t,!0,!0);for(var i=0;i<s.stations.length;i++){var a=s.stations[i],n=enmodal.transit_interface.get_station_marker_by_station(a);n.generate_popup(),n.update_tooltip()}}}draw_service(e,t,s,i){i&&(t.station_markers.clearLayers(),this.station_markers=[],t.line_paths.clearLayers(),this.layers.inactive.station_markers.clearLayers(),this.layers.inactive.line_paths.clearLayers());var a;if(s)for(a=0;a<enmodal.transit_map.services.length;a++)enmodal.transit_map.services[a].sid!=e.sid&&this.draw_service(enmodal.transit_map.services[a],this.layers.inactive,!1,!1);for(a=0;a<e.stations.length;a++){var n=e.stations[a];this.create_station_marker(n,t.station_markers,s,!1)}for(a=0;a<e.lines.length;a++){var r=e.lines[a];this.draw_line(r,!1,!0,t.line_paths,s,e)}}get_insertion_result(e,t){for(var s,i=[],a=[],n=-1,r=e.length(),o=0;o<e.stops.length;o++){for(var l=0;l<e.stops.length;l++)if(o!=l&&e.stops[o].sid!=t.sid&&e.stops[l].sid!=t.sid){var _=[e.stops[o],e.stops[l]],d=new Edge([t,e.stops[o]],!0),c=new Edge([t,e.stops[l]],!0);s=r+d.length()+c.length();for(var p=null,h=0;h<e.edges.length;h++)e.edges[h].compare_stops(_)&&(s-=e.edges[h].length(),p=e.edges[h]);(s<n||0===i.length)&&(n=s,i=[d,c],a=[p])}if(e.stops[o].sid!=t.sid){var m=new Edge([t,e.stops[o]],!0);((s=r+m.length())<n||0===i.length)&&(n=s,i=[m],a=[])}}return new LineDelta(i,a)}lines_for_station_by_station_pair(e){for(var t=[],s=0;s<this.station_pairs.length;s++)if(this.station_pairs[s].has_station(e))for(var i=this.station_pairs[s].lines(),a=0;a<i.length;a++)-1==t.indexOf(i[a])&&t.push(i[a]);return t}create_station_marker(e,t,s,i){var a=new StationMarker(e,s);s&&(a.marker.on("click",function(e){a.marker.closeTooltip(),enmodal.transit_interface.map.off("click",handle_map_click),setTimeout(function(){enmodal.transit_interface.map.on("click",handle_map_click)},1e3),a.generate_popup()}),a.marker.on("mousedown",function(e){enmodal.transit_interface.preview_paths_enabled=!1,enmodal.transit_interface.preview_clear(),enmodal.transit_interface.map.dragging.disable();let{lat:t,lng:s}=a.marker._latlng,{lat:i,lng:n}=e.latlng;enmodal.transit_interface.map.on("mousemove",e=>{if("station"==enmodal.transit_interface.active_tool){null===enmodal.transit_interface.moving_station_marker&&(enmodal.transit_interface.moving_station_marker=a);let{lat:v,lng:g}=e.latlng,f=[t-(i-v),s-(n-g)];a.marker.setLatLng(f),a.marker.closeTooltip(),enmodal.transit_interface.map.closePopup(),a.station.move_to(f[0],f[1]);for(var r=enmodal.transit_interface.lines_for_station_by_station_pair(a.station),o=[],l=0;l<r.length;l++){enmodal.transit_interface.draw_line(r[l],!0,!1,enmodal.transit_interface.layers.active.line_paths,!0,enmodal.transit_interface.active_service);for(var _=enmodal.transit_interface.get_station_pairs_for_line(r[l]),d=0;d<_.length;d++)_[d]in o||o.push(_[d])}for(l=0;l<o.length;l++)o[l].draw();if(enmodal.transit_interface.draw_transfers(),ALLOW_STATION_MERGING){var c=!1,p=enmodal.transit_interface.map.latLngToLayerPoint(L.latLng(f[0],f[1]));if(enmodal.transit_interface.active_service.station_is_end_of_line(a.station)){for(l=0;l<enmodal.transit_interface.active_service.stations.length;l++){var h=enmodal.transit_interface.active_service.stations[l],m=enmodal.transit_interface.map.latLngToLayerPoint(L.latLng(h.location[0],h.location[1])),u=p.distanceTo(m);h.sid!=a.station.sid&&(u<STATION_MERGE_THRESHOLD?enmodal.transit_interface.active_service.station_is_end_of_line(h)&&(enmodal.transit_interface.get_station_marker_by_station(h).show_merge(),enmodal.transit_interface.get_station_marker_by_station(h).marker.bringToFront(),enmodal.transit_interface.station_to_merge=h,c=!0):enmodal.transit_interface.get_station_marker_by_station(h).clear_merge())}c||(enmodal.transit_interface.station_to_merge=null)}}}})}));for(var n=!1,r=0;r<this.station_markers.length;r++)e==this.station_markers[r].station&&(this.station_markers[r]=a,n=!0);return n||this.station_markers.push(a),a.marker.addTo(t),i&&a.marker.openPopup(),a}get_station_marker_by_station(e){for(var t=0;t<this.station_markers.length;t++)if(e.sid==this.station_markers[t].station.sid)return this.station_markers[t];return null}get_station_marker_by_marker(e){for(var t=0;t<this.station_markers.length;t++)if(e==this.station_markers[t].marker)return this.station_markers[t];return null}add_new_station(e,t){var s,i=new Station("...",[e,t]),a=this.active_line;s=new Stop(i),this.active_service.add_station(i),a.add_stop(s);var n,r,o,l,_,d=[a],c=[];if(a.stops.length>1){var p=this.get_insertion_result(a,s);c=p.add;var h=p.remove;for(r=0;r<c.length;r++)for(c[r].sid=enmodal.id_factory.id(),a.add_edge(c[r]),o=0;o<c[r].stops.length;o++){var m=this.get_station_pairs(c[r].stops[o].station);for(l=0;l<m.length;l++){var u=m[l][0].line_spline_segments;for(_=0;_<u.length;_++){var v=u[_].line;-1==d.indexOf(v)&&d.push(v)}}}for(r=0;r<h.length;r++){for(o=0;o<h[r].stops.length;o++){var g=h[r].stops[o].station,f=this.active_service.station_lines(g);for(l=0;l<f.length;l++)-1==d.indexOf(f[l])&&d.push(f[l])}a.remove_edge(h[r]),INC_UPDATES&&(n=$.param({i:enmodal.session_id,service_id:this.active_service.sid,line_id:a.sid,edge_id:h[r].sid}),$.ajax({url:"edge_remove?"+n,async:ASYNC_REQUIRED,dataType:"json",success:check_server_error}))}}n=$.param({i:enmodal.session_id,service_id:this.active_service.sid,station_id:i.sid,lat:e,lng:t}),$.ajax({url:"station_add?"+n,async:ASYNC_REQUIRED,dataType:"json",success:function(e,t){check_server_error(e),i.name=e.name,"locality"in e&&(i.locality=e.locality),"neighborhood"in e&&(i.neighborhood=e.neighborhood),"region"in e&&(i.region=e.region);var r=enmodal.transit_interface.get_station_marker_by_station(i);r.generate_popup(),r.update_tooltip(),enmodal.sidebar.update_line_diagram(),n=$.param({i:enmodal.session_id,service_id:enmodal.transit_interface.active_service.sid,line_id:a.sid,station_id:i.sid,stop_id:s.sid}),INC_UPDATES&&$.ajax({url:"stop_add?"+n,async:!1,dataType:"json",success:function(e,t){check_server_error(e);for(var s=0;s<c.length;s++){var i=$.param({i:enmodal.session_id,service_id:enmodal.transit_interface.active_service.sid,line_id:a.sid,stop_1_id:c[s].stops[0].sid,stop_2_id:c[s].stops[1].sid,edge_id:c[s].sid});$.ajax({url:"edge_add?"+i,async:ASYNC_REQUIRED,dataType:"json",success:check_server_error})}}})}});this.create_station_marker(i,this.layers.active.station_markers,!0,!0);for(r=0;r<d.length;r++)this.draw_line(d[r],!1,!0,this.layers.active.line_paths,!0,this.active_service);return this.purge_station_pairs(),enmodal.data.get_ridership(),enmodal.sidebar.update_line_diagram(),push_undo_buffer(),i}clean_edges(e){for(var t,s,i=e.remove_self_edges(),a=0;a<i.length;a++)t=i[a],INC_UPDATES&&(s=$.param({i:enmodal.session_id,service_id:this.active_service.sid,line_id:e.sid,edge_id:t.sid}),$.ajax({url:"edge_remove?"+s,async:ASYNC_REQUIRED,dataType:"json",success:check_server_error}));for(i=e.remove_duplicate_edges(),a=0;a<i.length;a++)t=i[a],INC_UPDATES&&(s=$.param({i:enmodal.session_id,service_id:this.active_service.sid,line_id:e.sid,edge_id:t.sid}),$.ajax({url:"edge_remove?"+s,async:ASYNC_REQUIRED,dataType:"json",success:check_server_error}))}add_edge(e,t,s){if(t.add_edge(s),INC_UPDATES){var i=$.param({i:enmodal.session_id,service_id:e.sid,line_id:t.sid,stop_1_id:s.stops[0].sid,stop_2_id:s.stops[1].sid,edge_id:s.sid});$.ajax({url:"edge_add?"+i,async:ASYNC_REQUIRED,dataType:"json",success:function(e,t){check_server_error(e)}})}}merge_stations(e,t){for(var s=0;s<this.active_service.lines.length;s++){for(var i=this.active_service.lines[s],a=null,n=null,r=0;r<i.stops.length;r++){var o=i.stops[r];o.station.sid==e.sid&&(a=o),o.station.sid==t.sid&&(n=o)}if(null!==a&&null!==n){var l=new Edge([a,n]);if(i.add_edge(l),INC_UPDATES){var _=$.param({i:enmodal.session_id,service_id:this.active_service.sid,line_id:i.sid,stop_1_id:l.stops[0].sid,stop_2_id:l.stops[1].sid,edge_id:l.sid});$.ajax({url:"edge_add?"+_,async:ASYNC_REQUIRED,dataType:"json",success:check_server_error})}}this.clean_edges(i)}this.remove_station(e.sid,!0);var d=this.active_service.station_lines(t);for(s=0;s<d.length;s++)this.draw_line(d[s],!1,!0,this.layers.active.line_paths,!0,this.active_service)}update_station_info(e){var t=e.location[0],s=e.location[1],i=$.param({i:enmodal.session_id,lat:t,lng:s});$.ajax({url:"lat_lng_info?"+i,async:ASYNC_OPTIONAL,dataType:"json",success:function(t,s){check_server_error(t),e.name=t.name,"locality"in t&&(e.locality=t.locality),"neighborhood"in t&&(e.neighborhood=t.neighborhood),"region"in t&&(e.region=t.region),INC_UPDATES&&enmodal.transit_interface.sync_station_info(e)}})}sync_station_info(e){var t=$.param({i:enmodal.session_id,service_id:this.active_service.sid,station_id:e.sid,name:e.name,location:e.location[0].toString()+","+e.location[1].toString(),neighborhood:e.neighborhood});$.ajax({url:"station_update?"+t,async:ASYNC_REQUIRED,dataType:"json",success:function(e,t){check_server_error(e),enmodal.data.get_ridership()}})}add_stop_to_station(e){var t=this.active_service.get_station_by_id(e);if(null!==t){var s=new Stop(t);this.active_line.add_stop(s);var i,a,n,r,o,l,_=[this.active_line],d=[];if(this.active_line.stops.length>1){var c=this.get_insertion_result(this.active_line,s);d=c.add;var p=c.remove;for(i=0;i<d.length;i++){for(d[i].sid=_id_factory.id(),a=0;a<d[i].stops.length;a++)for(o=d[i].stops[a].station,l=this.active_service.station_lines(o),n=0;n<l.length;n++)-1==_.indexOf(l[n])&&_.push(l[n]);this.active_line.add_edge(d[i])}for(i=0;i<p.length;i++){for(a=0;a<p[i].stops.length;a++)for(o=p[i].stops[a].station,l=this.active_service.station_lines(o),n=0;n<l.length;n++)-1==_.indexOf(l[n])&&_.push(l[n]);this.active_line.remove_edge(p[i]),INC_UPDATES&&(r=$.param({i:enmodal.session_id,service_id:this.active_service.sid,line_id:this.active_line.sid,edge_id:p[i].sid}),$.ajax({url:"edge_remove?"+r,async:ASYNC_REQUIRED,dataType:"json",success:check_server_error}))}}for(INC_UPDATES&&(r=$.param({i:enmodal.session_id,service_id:this.active_service.sid,line_id:this.active_line.sid,station_id:t.sid,stop_id:s.sid}),$.ajax({url:"stop_add?"+r,async:ASYNC_REQUIRED,dataType:"json",success:function(e,t){for(var s=0;s<d.length;s++){var i=$.param({i:enmodal.session_id,service_id:enmodal.transit_interface.active_service.sid,line_id:enmodal.transit_interface.active_line.sid,stop_1_id:d[s].stops[0].sid,stop_2_id:d[s].stops[1].sid,edge_id:d[s].sid});$.ajax({url:"edge_add?"+i,async:ASYNC_REQUIRED,dataType:"json",success:check_server_error})}}})),i=0;i<this.station_markers.length;i++)this.station_markers[i].station.sid==t.sid&&this.station_markers[i].generate_popup();for(i=0;i<_.length;i++)this.draw_line(_[i],!1,!0,this.layers.active.line_paths,!0,this.active_service);this.purge_station_pairs(),enmodal.data.get_ridership(),enmodal.sidebar.update_line_diagram(),push_undo_buffer()}}remove_station(e,t){var s,i,a,n,r,o,l,_,d,c,p=[],h=[];for(s=0;s<this.active_service.lines.length;s++)for(l=this.active_service.lines[s],i=0;i<l.stops.length;i++)(d=l.stops[i]).station.sid==e&&(h.push(d),l.stops.splice(i,1),INC_UPDATES&&(c=$.param({i:enmodal.session_id,service_id:this.active_service.sid,line_id:l.sid,stop_id:d.sid}),$.ajax({url:"stop_remove?"+c,async:ASYNC_REQUIRED,dataType:"json",success:check_server_error})),-1==p.indexOf(l)&&p.push(l),i-=1);for(s=0;s<p.length;s++){l=p[s];var m=[];for(i=0;i<l.edges.length;i++)for(_=l.edges[i],a=0;a<h.length;a++)if(_.has_stop(h[a])){for(m.push(_),n=0;n<_.stops.length;n++){var u=this.get_station_pairs(_.stops[n].station);for(r=0;r<u.length;r++){var v=u[r][0].line_spline_segments;for(o=0;o<v.length;o++){var g=v[o].line;-1==p.indexOf(g)&&p.push(g)}}}l.remove_edge(_),c=$.param({i:enmodal.session_id,service_id:this.active_service.sid,line_id:l.sid,edge_id:_.sid}),INC_UPDATES&&$.ajax({url:"edge_remove?"+c,async:ASYNC_REQUIRED,dataType:"json",success:check_server_error}),i-=1}if(m.length>1){var f=m[Math.floor(Math.random()*m.length)],y=f.stops[0];for(y.station.sid==e&&(y=f.stops[1]),n=0;n<m.length;n++)if((_=m[n]).sid!=f.sid){var b=_.stops[0];if(b.station.sid==e&&(b=_.stops[1]),b.sid!=y.sid&&(!l.path_between_stops(b,y)||t)){var T=new Edge([y,b]);l.add_edge(T),INC_UPDATES&&(c=$.param({i:enmodal.session_id,service_id:this.active_service.sid,line_id:l.sid,stop_1_id:T.stops[0].sid,stop_2_id:T.stops[1].sid,edge_id:T.sid}),$.ajax({url:"edge_add?"+c,async:ASYNC_REQUIRED,dataType:"json",success:check_server_error}))}}for(n=0;n<l.stops.length;n++){d=l.stops[n];var S=!0;for(r=0;r<l.edges.length;r++)(_=l.edges[r]).has_stop(d)&&(S=!1);if(S){var w=this.get_insertion_result(l,d),E=w.add,L=w.remove;for(r=0;r<E.length;r++)E[r].sid=NS_id.id(),l.add_edge(E[r]),INC_UPDATES&&(c=$.param({i:enmodal.session_id,service_id:this.active_service.sid,line_id:l.sid,stop_1_id:E[r].stops[0].sid,stop_2_id:E[r].stops[1].sid,edge_id:E[r].sid}),$.ajax({url:"edge_add?"+c,async:ASYNC_REQUIRED,dataType:"json",success:check_server_error}));for(r=0;r<L.length;r++)l.remove_edge(L[r]),INC_UPDATES&&(c=$.param({i:enmodal.session_id,service_id:this.active_service.sid,line_id:l.sid,edge_id:L[r].sid}),$.ajax({url:"edge_remove?"+c,async:ASYNC_REQUIRED,dataType:"json",success:check_server_error}))}}this.clean_edges(l)}}for(s=0;s<this.active_service.stations.length;s++){var k=this.active_service.stations[s];k.sid==e&&(this.active_service.stations.splice(s,1),INC_UPDATES&&(c=$.param({i:enmodal.session_id,service_id:this.active_service.sid,station_id:k.sid}),$.ajax({url:"station_remove?"+c,async:ASYNC_REQUIRED,dataType:"json",success:check_server_error})),this.active_service.remove_transfers_for_station(k)&&this.draw_transfers())}for(s=0;s<this.station_markers.length;s++){var I=this.station_markers[s];I.station.sid==e&&(this.layers.active.station_markers.removeLayer(I.marker),this.station_markers.splice(s,1))}for(s=this.station_pairs.length-1;s>=0;s--){var N=this.station_pairs[s];N.stations[0].sid!=e&&N.stations[1].sid!=e||(this.station_pairs[s].undraw(),this.station_pairs.splice(s,1))}for(s=0;s<p.length;s++)this.draw_line(p[s],!1,!0,this.layers.active.line_paths,!0,this.active_service);enmodal.data.get_ridership(),enmodal.sidebar.update_line_diagram(),push_undo_buffer()}remove_line_from_station(e,t){var s,i,a,n,r,o,l,_,d=this.active_service.get_line_by_id(t),c=this.active_service.get_station_by_id(e),p=d.get_stops_by_station(c),h=this.active_service.station_lines(c);if(1==h.length)return this.remove_station(e,!1),0;for(n=0;n<p.length;n++)for(i=p[n],d.remove_stop(i),INC_UPDATES&&(_=$.param({i:enmodal.session_id,service_id:this.active_service.sid,line_id:d.sid,stop_id:i.sid}),$.ajax({url:"stop_remove?"+_,async:ASYNC_REQUIRED,dataType:"json",success:check_server_error})),a=[],r=0;r<d.edges.length;r++)(s=d.edges[r]).has_stop(i)&&(a.push(s),d.remove_edge(s),INC_UPDATES&&(_=$.param({i:enmodal.session_id,service_id:this.active_service.sid,line_id:d.sid,edge_id:s.sid}),$.ajax({url:"edge_remove?"+_,async:ASYNC_REQUIRED,dataType:"json",success:check_server_error})),r-=1);if(a.length>1){var m=a[Math.floor(Math.random()*a.length)],u=m.stops[0];for(u.station.sid==e&&(u=m.stops[1]),o=0;o<a.length;o++)if((s=a[o]).sid!=m.sid){var v=s.stops[0];if(v.station.sid==e&&(v=s.stops[1]),v.sid!=u.sid){var g=new Edge([u,v]);d.add_edge(g),INC_UPDATES&&(_=$.param({i:enmodal.session_id,service_id:this.active_service.sid,line_id:d.sid,stop_1_id:g.stops[0].sid,stop_2_id:g.stops[1].sid,edge_id:g.sid}),$.ajax({url:"edge_add?"+_,async:ASYNC_REQUIRED,dataType:"json",success:check_server_error}))}}for(o=0;o<d.stops.length;o++){i=d.stops[o];var f=!0;for(l=0;l<d.edges.length;l++)(s=d.edges[l]).has_stop(i)&&(f=!1);if(f){var y=this.get_insertion_result(d,i),b=y.add,T=y.remove;for(n=0;n<b.length;n++)b[n].sid=NS_id.id(),d.add_edge(b[n]),INC_UPDATES&&(_=$.param({i:enmodal.session_id,service_id:this.active_service.sid,line_id:d.sid,stop_1_id:b[n].stops[0].sid,stop_2_id:b[n].stops[1].sid,edge_id:b[n].sid}),$.ajax({url:"edge_add?"+_,async:ASYNC_REQUIRED,dataType:"json",success:check_server_error}));for(n=0;n<T.length;n++)d.remove_edge(T[n]),INC_UPDATES&&(_=$.param({i:enmodal.session_id,service_id:this.active_service.sid,line_id:d.sid,edge_id:T[n].sid}),$.ajax({url:"edge_remove?"+_,async:ASYNC_REQUIRED,dataType:"json",success:check_server_error}))}}}for(n=0;n<h.length;n++)this.draw_line(h[n],!1,!0,this.layers.active.line_paths,!0,this.active_service);this.get_station_marker_by_station(c).generate_popup(),enmodal.data.get_ridership(),enmodal.sidebar.update_line_diagram(),push_undo_buffer()}update_station_markers(e){for(var t=0;t<e.stops.length;t++){var s=e.stops[t].station,i=this.get_station_marker_by_station(s),a=num_unique_colors(this.active_service.station_lines(s));i.set_radius(2.5*Math.max(a,2))}}has_station_pair(e,t){for(var s=0;s<this.station_pairs.length;s++){var i=this.station_pairs[s];if(i.stations[0]==e&&i.stations[1]==t)return!0;if(i.stations[0]==t&&i.stations[1]==e)return!0}return!1}get_station_pair(e,t){for(var s=0;s<this.station_pairs.length;s++){var i=this.station_pairs[s];if(i.stations[0]==e&&i.stations[1]==t)return[i,0];if(i.stations[0]==t&&i.stations[1]==e)return[i,1]}return null}get_station_pair_by_sp_id(e){for(var t=0;t<this.station_pairs.length;t++)if(this.station_pairs[t].sid==e)return this.station_pairs[t];return null}get_station_pairs(e){for(var t=[],s=0;s<this.station_pairs.length;s++){var i=this.station_pairs[s];i.stations[0]==e&&t.push([i,0]),i.stations[1]==e&&t.push([i,1])}return t}get_station_pairs_for_line(e){for(var t=[],s=this.active_service.station_drawmap(e),i=0;i<s.length;i++)for(var a=s[i],n=0;n<a.length-1;n++){var r=a[n],o=a[n+1];if(this.has_station_pair(r,o)){var l=this.get_station_pair(r,o)[0];t.push(l)}}return t}draw_line(e,t,s,i,a,n){var r,o,l,_,d,c,p,h,m;e.sid in this.line_paths?m=this.line_paths[e.sid]:(m=new LinePath,this.line_paths[e.sid]=m);for(r=0;r<m.edge_paths.length;r++)this.layers.active.line_paths.removeLayer(m.edge_paths[r].path);for(r=0;r<this.station_pairs.length;r++)this.station_pairs[r].has_line(e)&&(this.station_pairs[r].clear_spline_segment_for_line(e),this.station_pairs[r].generate_paths(a),s&&this.station_pairs[r].draw(i));var u=[];if(e.stops.length>1){var v=n.station_drawmap(e);for(r=0;r<v.length;r++){var g=v[r],f=[],y={},b=0;for(o=0;o<g.length;o++)if(f.push({x:g[o].location[0],y:g[o].location[1]}),g[o].sid in y?y[g[o].sid].push(b):y[g[o].sid]=[b],b+=1,o<g.length-1&&(_=g[o],d=g[o+1],this.has_station_pair(_,d))){c=(p=this.get_station_pair(_,d))[0];var T=[];for(l=0;l<c.pins.length;l++)T.push({x:c.pins[l].location[0],y:c.pins[l].location[1]}),b+=1;p[1]&&(T=T.reverse()),f.push.apply(f,T)}var S=new BezierSpline({points:f,sharpness:BEZIER_SHARPNESS,duration:2});for(o=0;o<g.length-1;o++){_=g[o],d=g[o+1],this.has_station_pair(_,d)?(c=(p=this.get_station_pair(_,d))[0],h=p[1]):(c=new StationPair(n,[_,d],this.layers.active.line_paths),this.station_pairs.push(c),h=0);var w=y[_.sid][0],E=y[d.sid][0],L=[];for(l=0;l<E-w;l++)if(w+l+1<=S.centers.length){var k=[],$=[];k.push(new BezierCenter(f[w+l].x,f[w+l].y)),$.push(new BezierControlPoint(S.controls[w+l][1].x,S.controls[w+l][1].y)),$.push(new BezierControlPoint(S.controls[w+l+1][0].x,S.controls[w+l+1][0].y)),k.push(new BezierCenter(f[w+l+1].x,f[w+l+1].y)),1==h&&(k=k.reverse(),$=$.reverse());var I=new SplineSegment($,k);L.push(I)}1==h&&(L=L.reverse());var N=new LineSplineSegment(e,L,h);c.add_line_spline_segment(N),c.generate_paths(a),u.push(c),y[_.sid].splice(0,1)}}this.update_station_markers(e)}if(s)for(r=0;r<u.length;r++)u[r].draw(i),t&&u[r].draw_pins(i)}draw_transfers(){this.layers.active.transfers.clearLayers();for(var e=0;e<enmodal.transit_interface.active_service.transfers.length;e++)this.draw_transfer(enmodal.transit_interface.active_service.transfers[e])}draw_transfer(e){var t=e.stations[0],s=e.stations[1],i={weight:TRANSFER_WIDTH,color:"black",opacity:1};station_distance(t,s)>MAX_TRANSFER_DISTANCE_MILES&&(i.dashArray="10,10",i.opacity=TRANSFER_PREVIEW_OPACITY);var a=L.polyline([L.latLng(t.location),L.latLng(s.location)],i);this.layers.active.transfers.addLayer(a)}draw_transfers_for_station(e){this.transfer_layer.clearLayers();for(var t=0;t<enmodal.transit_interface.active_service.transfers.length;t++)enmodal.transit_interface.active_service.transfers[t].has_station(e)&&this.draw_transfer(enmodal.transit_interface.active_service.transfers[t])}purge_bad_transfers(){this.active_service.remove_transfers_above_length(MAX_TRANSFER_DISTANCE_MILES)>0&&this.draw_transfers()}purge_station_pairs(){for(var e=this.station_pairs.length-1;e>=0;e--){var t=this.station_pairs[e];null!==this.active_service.get_station_by_id(t.stations[0].sid)&&null!==this.active_service.get_station_by_id(t.stations[1].sid)&&!1!==this.active_service.has_edge_for_stations(t.stations[0],t.stations[1])&&0!==t.lines().length||(t.undraw_pins(),this.station_pairs.splice(e,1))}}direct_station_pairs(){}regenerate_edge_path(e,t){this.line_paths[e.sid];this.layers.active.line_paths.removeLayer(t.path),t.regenerate_path(),this.layers.active.line_paths.addLayer(t.path)}refresh_edge_paths(e){for(var t=this.line_paths[e.sid],s=0;s<t.edge_paths.length;s++)this.layers.active.line_paths.removeLayer(t.edge_paths[s].path);for(var i=0;i<t.edge_paths.length;i++){t.edge_paths[i].regenerate_path();var a=t.edge_paths[i].path;this.layers.active.line_paths.addLayer(a)}}pin_projection(e,t){for(var s,i,a,n,r=this.map.latLngToLayerPoint(L.latLng(e,t)),o=null,l=-1,_=null,d=-1,c=[],p=0;p<this.station_pairs.length;p++){var h=this.station_pairs[p];if(h.service==this.active_service&&null!==(s=h.project_pin(e,t))&&((null===o||s.d<l)&&(o=s,l=s.d,d=h.sid,_=h),(a=r.distanceTo(this.map.latLngToLayerPoint(L.latLng(s.x,s.y))))<PIN_DISTANCE_TO_SHOW_PINS&&c.push(h.sid),DEBUG_PIN_PROJECTIONS)){var m=1;a<PIN_DISTANCE_TO_SHOW_PINS&&(m=2),n=L.polyline([L.latLng([s.x,s.y]),L.latLng(e,t)],{weight:m,color:"#00f"}),this.layers.preview.addLayer(n)}}var u=!1;if(null!==o&&(r=this.map.latLngToLayerPoint(L.latLng(e,t)),i=this.map.latLngToLayerPoint(L.latLng(o.x,o.y)),u=(a=r.distanceTo(i))<PIN_DISTANCE_MIN),DEBUG_PIN_PROJECTIONS&&null!==o&&(n=L.polyline([L.latLng([o.x,o.y]),L.latLng(e,t)],{weight:1,color:"#f00"}),this.layers.preview.addLayer(n)),u){var v=_.distance_to_nearest_pin(e,t);v>-1&&v<PIN_DISTANCE_FROM_EXISTING_PIN_MIN&&(u=!1)}return[u,o,d,c]}preview_line(e,t,s){this.preview_clear();var i,a,n,r=this.map.latLngToLayerPoint(L.latLng(t,s)),o=0,l=null;for(i=0;i<enmodal.transit_interface.active_service.stations.length;i++){n=enmodal.transit_interface.active_service.stations[i];var _=r.distanceTo(this.map.latLngToLayerPoint(L.latLng(n.location[0],n.location[1])));(o>_||null===l)&&(l=n,o=_)}var d=this.pin_projection(t,s);if(!this.dragging_pin)if(d[0]&&o>PIN_DISTANCE_FROM_STATION_MIN){var c=L.marker([d[1].x,d[1].y],{icon:PIN_ICON});c.id="pin-preview",this.preview_line_pin_marker=c,this.layers.preview.addLayer(c)}else{n=new Station("preview",[t,s],!0);var p=new Stop(n,!0),h=this.get_insertion_result(e,p);for(a=0;a<h.add.length;a++){var m=h.add[a],u=[[m.stops[0].station.location[0],m.stops[0].station.location[1]],[m.stops[1].station.location[0],m.stops[1].station.location[1]]],v=new EdgePath(m.sid,u,[],[],e.color_bg,.2);this.preview_paths.push(v),this.layers.preview.addLayer(v.path)}}for(a=0;a<this.station_pairs.length;a++){var g=this.station_pairs[a];d[3].indexOf(g.sid)>-1?g.draw_pins():g.undraw_pins()}}preview_transfer(e,t){this.preview_clear();var s={type:"Feature",properties:{},geometry:{type:"Point",coordinates:[this.active_transfer_station.location[1],this.active_transfer_station.location[0]]}},i={type:"Feature",properties:{},geometry:{type:"Point",coordinates:[t,e]}},a={type:"Feature",properties:{},geometry:{type:"LineString",coordinates:[[this.active_transfer_station.location[1],this.active_transfer_station.location[0]],[t,e]]}},n=turf.lineChunk(a,MAX_TRANSFER_DISTANCE_MILES,"miles"),r=(turf.distance(s,i,"miles"),L.polyline([L.latLng(n.features[0].geometry.coordinates[1][1],n.features[0].geometry.coordinates[1][0]),L.latLng(this.active_transfer_station.location[0],this.active_transfer_station.location[1])],{weight:TRANSFER_WIDTH,color:"black",opacity:TRANSFER_PREVIEW_OPACITY}));this.layers.preview.addLayer(r)}preview_clear(){this.layers.preview.clearLayers(),this.preview_paths=[]}preview_handler(e){this.preview_paths_enabled&&("station"==this.active_tool&&null!==this.active_line&&this.preview_line(this.active_line,e.latlng.lat,e.latlng.lng),"transfer"==this.active_tool&&this.preview_transfer(e.latlng.lat,e.latlng.lng))}draw_bezier_rep_for_station(e){for(var t=this.get_station_pairs(e),s=0;s<t.length;s++){var i=[];t[s][0].stations[0].sid==e.sid&&i.push(t[s][0].markers()[0].marker.getLatLng()),t[s][0].stations[1].sid==e.sid&&i.push(t[s][0].markers()[1].marker.getLatLng()),i.push(L.latLng(e.location[0],e.location[1])),this.bezier_layer.addLayer(L.polyline(i,{color:"#A77",weight:1,dashArray:"4,4"}))}}draw_bezier_rep(e,t,s,i){var a=[],n=1;e.stations[0].sid!=s.sid&&i||(a.push(L.latLng(e.stations[0].location[0],e.stations[0].location[1])),n=0);for(var r=e.markers(),o=0;o<Math.min(t,r.length);o++)1==n?a.push(r[r.length-o-1].marker.getLatLng()):a.push(r[o].marker.getLatLng());(t>=r.length||!i)&&e.stations[1].sid==s.sid&&a.push(L.latLng(e.stations[1].location[0],e.stations[1].location[1])),this.bezier_layer.addLayer(L.polyline(a,{color:"red",weight:1,dashArray:"2,2"}))}settings(){return{station_pairs:this.station_pairs}}}class LineDelta{constructor(e,t){this.add=e,this.remove=t}}class StationMarker{constructor(e,t){this.station=e,this.active=t,this.tooltip_options={direction:"top",offset:L.point(0,-5),className:"station-marker-tooltip"},this.marker=this.generate_marker(),this.popup=L.popup({className:"station-popup"}),this.merge_pending=!1,this.marker.bindPopup(this.popup),this.radius=MARKER_RADIUS_DEFAULT,this.generate_popup()}generate_marker(){var e=L.latLng(this.station.location[0],this.station.location[1]),t=1;this.active||(t=INACTIVE_OPACITY);var s=L.circleMarker(e,{draggable:!0,color:"black",opacity:t,fillColor:"white",fillOpacity:t,zIndexOffset:100,pane:"stationMarkerPane"}).setRadius(this.radius).bindTooltip(this.station.name,this.tooltip_options);return this.active&&s.on("click",function(e){if("transfer"==enmodal.transit_interface.active_tool){s.unbindPopup();var t=enmodal.transit_interface.get_station_marker_by_marker(s).station;if(t!=enmodal.transit_interface.active_transfer_station){var i={type:"Feature",properties:{},geometry:{type:"Point",coordinates:[t.location[1],t.location[0]]}},a={type:"Feature",properties:{},geometry:{type:"Point",coordinates:[enmodal.transit_interface.active_transfer_station.location[1],enmodal.transit_interface.active_transfer_station.location[0]]}};turf.distance(i,a,"miles")<=MAX_TRANSFER_DISTANCE_MILES&&(enmodal.transit_interface.active_service.add_transfer(t,enmodal.transit_interface.active_transfer_station),enmodal.transit_interface.draw_transfers()),enmodal.transit_interface.active_tool="station",enmodal.transit_interface.preview_clear()}}}),s}set_radius(e){this.radius=e,this.marker.setRadius(e)}show_merge(){this.marker.setRadius(this.radius+MARKER_MERGE_DELTA),this.merge_pending=!0}clear_merge(){this.merge_pending&&(this.marker.setRadius(this.radius),this.merge_pending=!1)}generate_popup(){var e='<div class="station-name" id="station-'+this.station.sid.toString()+'" data-balloon="Click to rename" data-balloon-pos="left">'+this.station.name;e+='   <i class="fa fa-pencil" style="margin-left: 5px;" aria-hidden="true"></i>',e+="</div>",e+='<div class="station-content"><div class="station-info">'+this.station.neighborhood+"<br />",e+='<i class="fa fa-user" aria-hidden="true"></i> <span id="stationriders-'+this.station.sid.toString()+'">',-1==this.station.ridership?e+="...":e+=Math.round(this.station.ridership).toString(),e+="</span></div>",e+='<div class="station-info subway-lines">';for(var t=enmodal.transit_interface.active_service.station_lines(this.station),s=!0,i=0;i<t.length;i++){var a=t[i];e+='<div transit-station-id="'+this.station.sid.toString()+'" transit-line-id="'+a.sid.toString()+'" class="subway-line-long subway-deletable station-popup-line-marker" style="background-color: '+a.color_bg+"; color: "+a.color_fg+';" data-balloon="Remove" data-balloon-pos="down"><div class="content">'+a.name+"</div></div>",a.sid==enmodal.transit_interface.active_line.sid&&(s=!1)}null===enmodal.transit_interface.active_line&&(s=!1),e+=" </div>",s&&(e+='<div class="station-content-button station-build line-'+enmodal.transit_interface.active_line.sid.toString()+'" id="'+this.station.sid.toString()+'">Build <div class="subway-line-long subway-line-mini" style="background-color: '+enmodal.transit_interface.active_line.color_bg+"; color: "+enmodal.transit_interface.active_line.color_fg+';"><div class="content">'+enmodal.transit_interface.active_line.name+"</div></div></div>"),e+='<div class="station-content-button station-delete" transit-station-id="'+this.station.sid.toString()+'">Delete</div>',e+='<div class="station-buttons"><div class="station-content-button station-transfer" id="transfer-'+this.station.sid.toString()+'">Transfer</div>',e+='</div><div style="clear: both;"></div>',e+="</div>",this.popup.setContent(e),this.popup.update(),this.marker.bindPopup(this.popup)}update_tooltip(){this.marker.setTooltipContent(this.station.name)}}var GAME_VERSION=.13,INC_UPDATES=!0,ASYNC_REQUIRED=!0,ASYNC_OPTIONAL=!1,CURVE_THRESHOLD=.005,MARKER_RADIUS_DEFAULT=4,MARKER_RADIUS_LARGE=8,MARKER_RADIUS_HUGE=12,MARKER_MERGE_DELTA=4,STATION_MARKER_LARGE_THRESHOLD=3,STATION_MARKER_HUGE_THRESHOLD=4,STATION_MARKER_SCALE_THRESHOLD=6,TRACK_WIDTH=4,TRACK_OFFSET=4,TRANSFER_WIDTH=3,TRANSFER_PREVIEW_OPACITY=.75,MAX_TRANSFER_DISTANCE_MILES=.25,USE_CURVED_TRACKS=!0,CURVE_OVERSHOOT=.5,BEZIER_SHARPNESS=.4,DGGRID_AREA=.0733633,MAX_ZOOM=16,MIN_ZOOM=6,START_ZOOM=13,MIN_ZOOM_FOR_HEXAGONS=13,DEBUG_MODE=!1,SHARED_STRETCH_THRESHOLD=8,TRANSFER_BUTTON_DEFAULT="Start Transfer",TRANSFER_BUTTON_START="Click a station",TRANSFER_BUTTON_END="Click another station",RIDERSHIP_ADD=0,RIDERSHIP_NOCHANGE=1,RIDERSHIP_DELETE=2,CUSTOM_LINE_FIRST_INDEX=97,FOLLOW_STREET_MOVE_THRESH=500,PIN_DISTANCE_MIN=16,PIN_DISTANCE_FROM_STATION_MIN=8,PIN_DISTANCE_TO_SHOW_PINS=100,PIN_DISTANCE_FROM_EXISTING_PIN_MIN=40,INACTIVE_OPACITY=.25,BEZIER_LUT_STEPS=100,STATION_MERGE_THRESHOLD=8,ALLOW_STATION_MERGING=!0,SERVICE_MODES_ENABLED=!1,PIN_ICON=L.icon({iconUrl:"static/img/pin.png",iconSize:[30,25],iconAnchor:[15,25]}),DEFAULT_LINE_BG="#808183",DEFAULT_LINE_FG="#FFF";HEXAGON_SCALES={population:chroma.scale("YlGnBu").domain([1,0]),employment:chroma.scale("YlOrRd").domain([1,0])},HEXAGON_UNITS={population:"persons / mile<sup>2</sup>",employment:"jobs /  mile<sup>2</sup>"};var DEBUG_BEZIER_CONTROLS=!1,DEBUG_PIN_PROJECTIONS=!1,GTFS_ENABLED=!0,UNDO_BUFFER_SIZE=20;class Sharing{constructor(){}update(e,t){console.log(location.origin),$("#share-link-public input").val(location.origin+"/?id="+e),$("#share-link-private input").val(location.origin+"/?id="+t)}}class Sidebar{constructor(){}add_to_line_selector(e){$("#dropdown-line-menu").prepend('<li class="line-selector-item"><a class="line-selector-option" transit-line-id="'+e.sid.toString()+'" href="#"> <div class="subway-line-long" style="background-color: '+e.color_bg+"; color: "+e.color_fg+';"><div class="content">'+e.name+"</div></div> "+e.full_name+"</a></li>")}new_line_name(){for(var e=[],t=0;t<enmodal.transit_interface.active_service.lines.length;t++){var s=enmodal.transit_interface.active_service.lines[t];1==s.name.length&&(isNaN(s.name)?e[s.name.charCodeAt(0)-65]=1:e[parseInt(s.name)+25]=1)}for(t=0;t<e.length;t++)if(1!=e[t])return t<26?String.fromCharCode(65+t):(t-25).toString();return e.length<26?String.fromCharCode(65+e.length):(e.length-25).toString()}random_color(){var e=Math.floor(200*Math.random()),t=Math.floor(200*Math.random()),s=Math.floor(200*Math.random());return new LineColor(e,t,s)}line_selector_new(){var e=new Line(this.new_line_name());e.full_name="Line";var t=this.random_color();if(e.color_bg=t.bg_hex(),e.color_fg=t.fg_hex(),INC_UPDATES){var s=$.param({i:enmodal.session_id,service_id:enmodal.transit_interface.active_service.sid,name:e.name,full_name:e.full_name,color_bg:e.color_bg,color_fg:e.color_fg,line_id:e.sid});$.ajax({url:"line_add?"+s,async:ASYNC_REQUIRED,dataType:"json",success:function(e,t){}})}return enmodal.transit_interface.active_service.add_line(e),this.add_to_line_selector(e),this.update_line_selector(e.sid),enmodal.transit_interface.preview_clear(),e}clear_line_selector(){enmodal.transit_interface.active_line=null,$("#dropdown-line-menu li.line-selector-item").remove(),$("#dropdown-line-button").html('Select a route... <span class="caret"></span>'),$("#custom-line-name").removeClass("issue"),$("#custom-line-error").text(""),$("#custom-line-name").val(""),$("#custom-line-options #color-picker-bg").spectrum("set","#808183"),$("#custom-line-options #color-picker-fg").spectrum("set","#FFF"),this.update_line_editor(),this.update_line_diagram()}update_line_selector(e){var t=enmodal.transit_interface.active_service.get_line_by_id(e);enmodal.transit_interface.active_line=t,$("#dropdown-line-button").html('<div class="subway-line-long" style="background-color: '+t.color_bg+"; color: "+t.color_fg+';"><div class="content">'+t.name+"</div></div> "+t.full_name+' <span class="caret"></span>'),$("#custom-line-name").removeClass("issue"),$("#custom-line-error").text(""),$("#custom-line-name").val(t.name),$("#custom-line-options #color-picker-bg").spectrum("set",t.color_bg),$("#custom-line-options #color-picker-fg").spectrum("set",t.color_fg),this.update_line_editor(),this.update_line_diagram(),enmodal.transit_interface.preview_clear()}update_line_editor(){var e=$("#custom-line-name").val();void 0!==e&&(e=e.substring(0,40)),$("#custom-line-marker-content").text(e);var t=$("#color-picker-bg").val();$("#custom-line-marker").css("background-color",t);var s=$("#color-picker-fg").val();$("#custom-line-marker").css("color",s)}refresh_line_editor(){$(".line-selector-item").remove();for(var e=0;e<enmodal.transit_interface.active_service.lines.length;e++){var t=enmodal.transit_interface.active_service.lines[e];$("#dropdown-line-menu").prepend('<li class="line-selector-item"><a class="line-selector-option" transit-line-id="'+t.sid.toString()+'" href="#"> <div class="subway-line-long" style="background-color: '+t.color_bg+"; color: "+t.color_fg+';"><div class="content">'+t.name+"</div></div> "+t.full_name+"</a></li>")}null!==enmodal.transit_interface.active_line?($("#custom-line-options #color-picker-bg").spectrum("set",enmodal.transit_interface.active_line.color_bg),$("#custom-line-options #color-picker-fg").spectrum("set",enmodal.transit_interface.active_line.color_fg)):($("#custom-line-options #color-picker-bg").spectrum("set",DEFAULT_LINE_BG),$("#custom-line-options #color-picker-fg").spectrum("set",DEFAULT_LINE_FG))}line_editor_save(){var e=enmodal.transit_interface.active_line,t=$("#custom-line-name").val();void 0!==t&&(t=t.substring(0,40));var s=$("#custom-line-options #color-picker-bg").val(),i=$("#custom-line-options #color-picker-fg").val(),a=!1;0===t.length&&($("#custom-line-name").addClass("issue"),$("#custom-line-error").text("Enter a name."),a=!0),a?$("#option-section-lines").animate({scrollTop:$("#option-section-lines").prop("scrollHeight")},1e3):(e.name=t,e.color_bg=s,e.color_fg=i,$("#custom-line-name").removeClass("issue"),$("#custom-line-css-bg").removeClass("issue"),$("#custom-line-css-text").removeClass("issue"),$("#custom-line-error").text(""),this.update_line_selector(e.sid),$("a[transit-line-id='"+e.sid.toString()+"']").html('<div class="subway-line-long" style="background-color: '+e.color_bg+"; color: "+e.color_fg+';"><div class="content">'+e.name+"</div></div> "+e.full_name),enmodal.transit_interface.draw_line(e,!1,!0,enmodal.transit_interface.layers.active.line_paths,!0,enmodal.transit_interface.active_service))}update_line_diagram(){function e(s){n[n.length-1].push(s),i[s.sid]=1;for(var a=t.neighbors(s),o=0,l=0;l<a.length;l++){var _=a[l];i[_.sid]||(o>0&&(n.push([]),n[n.length-1].push(s),r.push(s.sid)),o+=1,e(_))}}var t=enmodal.transit_interface.active_line;if(null!==t)if(0!==t.stops.length){for(var s=t.outer_stops()[0],i={},a=0;a<t.stops.length;a++)i[t.stops[a].sid]=0;var n=[[]],r=[];t.stops.length>0&&e(s),$("#route-diagram").empty();var o=0,l={},_=$('<div class="route-diagram-branch"></div>');$("#route-diagram").append(_);for(var d=0;d<n.length;d++){var c=n[d],p=0;for(d>0&&(p=1),a=p;a<c.length;a++){var h=c[a];if(a==p+1&&d>0&&(_=$('<div class="route-diagram-branch"></div>'),$("#route-diagram").append(_)),r.indexOf(h.sid)>-1){_=$('<div class="route-diagram-branch"></div>'),$("#route-diagram").append(_);var m=$('<div class="route-diagram-branch-connectors"></div>');_.append(m),m.append('<div class="route-diagram-connector-top-joint" style="background-color: '+t.color_bg+';"></div>'),m.append('<div class="route-diagram-connector-branch"><div class="route-diagram-connector-internal" style="background-color: '+t.color_bg+';"></div></div>'),m.append('<div class="route-diagram-connector-bottom-joint" style="background-color: '+t.color_bg+';"></div>')}var u=$('<div class="route-diagram-stop"></div>');_.append(u),u.append('<div class="route-diagram-station-marker"></div>'),a!=c.length-1&&u.append('<div class="route-diagram-connector" style="background-color: '+t.color_bg+'"></div>');var v=$('<div class="route-diagram-stop-info" id="station-'+h.station.sid.toString()+'"></div>');u.append(v),v.append('<div class="route-diagram-stop-name">'+h.station.name+"</div>");var g=$('<div class="route-diagram-stop-connectors"></div>');v.append(g),g.append('<div class="subway-line-long subway-line-mini subway-line-marker-diagram subway-line-marker-diagram-fake" style="font-size: 1em;"><div class="content"></div></div>');for(var f=[],y=0;y<enmodal.transit_interface.active_service.lines.length;y++)enmodal.transit_interface.active_service.lines[y].sid!=t.sid&&enmodal.transit_interface.active_service.lines[y].has_station(h.station)&&f.push(enmodal.transit_interface.active_service.lines[y]);for(y=0;y<enmodal.transit_interface.active_service.transfers.length;y++)if(enmodal.transit_interface.active_service.transfers[y].has_station(h.station))for(var b=enmodal.transit_interface.active_service.transfers[y].stations,T=0;T<b.length;T++)if(b[T]!=h.station)for(var S=enmodal.transit_interface.active_service.station_lines(b[T]),w=0;w<S.length;w++)-1==f.indexOf(S[w])&&f.push(S[w]);for(y=0;y<f.length;y++)g.append('<div class="subway-line-long subway-line-mini subway-line-marker-diagram" style="font-size: 1em; background-color: '+f[y].color_bg+"; color: "+f[y].color_fg+';"><div class="content">'+f[y].name+"</div></div>");l[h.sid]=o,o+=1}}}else $("#route-diagram").empty();else $("#route-diagram").empty()}add_to_service_selector(e){$("#dropdown-service-menu").prepend('<li class="service-selector-item"><a class="service-selector-option" transit-service-id="'+e.sid.toString()+'" href="#">'+e.name+"</a></li>")}service_selector_new(){var e=new Service("Service");if(INC_UPDATES){var t=$.param({i:enmodal.session_id,service_id:e.sid,name:e.name});$.ajax({url:"service_add?"+t,async:ASYNC_REQUIRED,dataType:"json",success:function(e,t){}})}return enmodal.transit_map.add_service(e),this.add_to_service_selector(e),this.update_service_selector(e.sid,!0),enmodal.transit_interface.active_line=null,this.clear_line_selector(),enmodal.transit_interface.preview_clear(),enmodal.transit_interface.draw_service(e,enmodal.transit_interface.layers.active,!0,!0),e}update_service_selector(e,t){var s=enmodal.transit_map.get_service_by_id(e);enmodal.transit_interface.active_service=s,$("#dropdown-service-button").html(s.name+' <span class="caret"></span>'),$("#custom-service-name").removeClass("issue"),$("#custom-service-error").text(""),$("#custom-service-name").val(s.name),$(".service-mode-button").removeClass("active"),"heavy_rail"==s.mode&&$("#service-option-heavy-rail").addClass("active"),"light_rail"==s.mode&&$("#service-option-light-rail").addClass("active"),"bus"==s.mode&&$("#service-option-bus").addClass("active"),s.lines.length>0?(this.update_line_selector(s.lines[0].sid),enmodal.transit_interface.active_line=s.lines[0]):(this.clear_line_selector(),enmodal.transit_interface.active_line=null),enmodal.transit_interface.preview_clear(),t&&enmodal.transit_interface.draw_service(s,enmodal.transit_interface.layers.active,!0,!0),this.update_line_editor(),this.refresh_line_editor(),this.update_line_diagram(),enmodal.leaflet_map.closePopup()}refresh_service_editor(){$(".service-selector-item").remove();for(var e=0;e<enmodal.transit_map.services.length;e++){var t=enmodal.transit_map.services[e];$("#dropdown-service-menu").prepend('<li class="service-selector-item"><a class="service-selector-option" transit-service-id="'+t.sid+'" href="#">'+t.name+"</a></li>")}}service_editor_save(){var e=enmodal.transit_interface.active_service,t=$("#custom-service-name").val().substring(0,20),s=!1;0===t.length&&($("#custom-service-name").addClass("issue"),$("#custom-service-error").text("Enter a name."),s=!0),s?$("#option-section-services").animate({scrollTop:$("#option-section-services").prop("scrollHeight")},1e3):(e.name=t,$("#custom-service-name").removeClass("issue"),$("#custom-service-css-bg").removeClass("issue"),$("#custom-service-css-text").removeClass("issue"),$("#custom-service-error").text(""),this.update_service_selector(e.sid,!1),$("a[transit-service-id='"+e.sid+"']").html(e.name))}}class StationPair{constructor(e,t,s){this.sid=_id_factory.id(),this.service=e,this.stations=t,this.line_spline_segments=[],this.paths=[],this.street_path=null,this.street_path_is_valid=!1,this.pins=[],this.draw_counter=0,this.group_sss=null,this.layer=s}set_layer(e){this.undraw(),this.layer=e}add_line_spline_segment(e){this.line_spline_segments.push(e),this.line_spline_segments.sort(function(e,t){return e.line.sid>t.line.sid})}clear_spline_segment_for_line(e){for(var t=this.line_spline_segments.length-1;t>=0;t--)this.line_spline_segments[t].line==e&&this.line_spline_segments.splice(t,1)}clear_spline_segments(){this.line_spline_segments=[]}lines(){for(var e=[],t=0;t<this.line_spline_segments.length;t++){var s=this.line_spline_segments[t].line;-1==e.indexOf(s)&&e.push(s)}return e}has_line(e){for(var t=0;t<this.line_spline_segments.length;t++)if(this.line_spline_segments[t].line==e)return!0;return!1}has_station(e){for(var t=0;t<this.stations.length;t++)if(this.stations[t].sid==e.sid)return!0;return!1}num_lines(){for(var e=[],t=0;t<this.line_spline_segments.length;t++){var s=this.line_spline_segments[t].line;-1==e.indexOf(s)&&e.push(s)}return e.length}num_lines_color(){for(var e=0,t=[],s=0;s<this.line_spline_segments.length;s++){var i=this.line_spline_segments[s].line;-1==t.indexOf(i.color_bg)&&(t.push(i.color_bg),e+=1)}return e}ss_pos(e){for(var t=[],s=0;s<this.line_spline_segments.length;s++){var i=this.line_spline_segments[s].line;-1==t.indexOf(i)&&t.push(i)}for(var a=0;a<t.length;a++)if(t[a]==e.line)return a;return-1}lss_pos_color(e){for(var t=[],s=0;s<this.line_spline_segments.length;s++){var i=this.line_spline_segments[s].line;-1==t.indexOf(i.color_bg)&&t.push(i.color_bg)}for(var a=0;a<t.length;a++)if(t[a]==e.line.color_bg)return a;return-1}average_sss(){for(var e,t=[],s=0;s<this.line_spline_segments.length;s++)for(var i=this.line_spline_segments[s],a=0;a<i.spline_segments.length;a++){var n=i.spline_segments[a];if(t.length<=a){var r=[],o=[];for(e=0;e<n.centers.length;e++)o.push(new BezierCenter(n.centers[e].lat,n.centers[e].lng));for(e=0;e<n.controls.length;e++)r.push(new BezierControlPoint(n.controls[e].lat,n.controls[e].lng));t.push(new SplineSegment(r,o))}else for(e=0;e<n.controls.length;e++)t[a].controls[e].lat+=n.controls[e].lat,t[a].controls[e].lng+=n.controls[e].lng}for(s=0;s<t.length;s++){var l=t[s];for(e=0;e<l.controls.length;e++)t[s].controls[e].lat=t[s].controls[e].lat/this.line_spline_segments.length,t[s].controls[e].lng=t[s].controls[e].lng/this.line_spline_segments.length}return this.group_sss=t,t}project_pin(e,t){for(var s=this.average_sss(),i=-1,a=null,n=0;n<s.length;n++){var r,o=s[n],l=(r=1==o.controls.length?new Bezier(o.centers[0].lat,o.centers[0].lng,o.controls[0].lat,o.controls[0].lng,o.centers[1].lat,o.centers[1].lng):new Bezier(o.centers[0].lat,o.centers[0].lng,o.controls[0].lat,o.controls[0].lng,o.controls[1].lat,o.controls[1].lng,o.centers[1].lat,o.centers[1].lng)).project({x:e,y:t});(null===a||l.d<i)&&(i=l.d,a=l)}return a}distance_to_nearest_pin(e,t){this.average_sss();for(var s=-1,i=0;i<this.pins.length;i++){var a=this.pins[i],n=enmodal.leaflet_map.latLngToLayerPoint(L.latLng(e,t)),r=enmodal.leaflet_map.latLngToLayerPoint(L.latLng(a.location[0],a.location[1])),o=n.distanceTo(r);(-1==s||o<s)&&(s=o)}return s}increment_draw_counter(){return this.draw_counter=this.draw_counter+1,this.draw_counter>FOLLOW_STREET_MOVE_THRESH&&(this.draw_counter=0,!0)}generate_path(e,t,s,i,a){var n=null,r=this;if("bus"==this.service.mode)if(this.increment_draw_counter()||!this.street_path_is_valid){var o=$.param({i:enmodal.session_id,service_id:enmodal.transit_interface.active_service.sid,station_1_lat:this.stations[0].location[0],station_1_lng:this.stations[0].location[1],station_2_lat:this.stations[1].location[0],station_2_lng:this.stations[1].location[1]});$.ajax({url:"street_path?"+o,async:!0,dataType:"json",success:function(e,o){handle_server_error(e);for(var l=[],_=0;_<e[0].length;_++)l.push([e[0][_][1],e[0][_][0]]);this.street_path=l,this.street_path_is_valid=!0,n=L.polyline(l,{weight:i,color:t,opacity:a,offset:s*(i/2)}),r.undraw_paths(),r.paths.push(n),r.draw_paths()}})}else n=L.polyline(r.street_path,{weight:i,color:t,opacity:a,offset:s*(i/2)});else{for(var l=this.average_sss(),_=[],d=0;d<l.length;d++){var c=l[d];_.push("M"),_.push([c.centers[0].lat,c.centers[0].lng]);var p=[];1==c.controls.length&&p.push("Q"),2==c.controls.length&&p.push("C");for(var h=0;h<c.controls.length;h++)p.push([c.controls[h].lat,c.controls[h].lng]);p.push([c.centers[1].lat,c.centers[1].lng]),_.push.apply(_,p)}var m={color:t,weight:i,opacity:a,fill:!1,smoothFactor:1,offset:s*(i/2),clickable:!1,"pointer-events":"none",className:"no-hover"};n=L.curve(_,m)}return n}add_pin(e,t){for(var s=this.average_sss(),i=-1,a=null,n=0;n<s.length;n++)for(var r,o=s[n],l=(r=1==o.controls.length?new Bezier(o.centers[0].lat,o.centers[0].lng,o.controls[0].lat,o.controls[0].lng,o.centers[1].lat,o.centers[1].lng):new Bezier(o.centers[0].lat,o.centers[0].lng,o.controls[0].lat,o.controls[0].lng,o.controls[1].lat,o.controls[1].lng,o.centers[1].lat,o.centers[1].lng)).getLUT(BEZIER_LUT_STEPS),_=0;_<l.length-1;_++){var d=enmodal.leaflet_map.distance(L.latLng(e,t),L.latLng(l[_].x,l[_].y));(-1==i||d<i)&&(a=_+n*BEZIER_LUT_STEPS,i=d)}var c=new Pin([e,t]);this.generate_pin_marker(c);var p=Math.floor(a/BEZIER_LUT_STEPS);this.pins.splice(p,0,c),this.draw_lines(),push_undo_buffer()}remove_pin(e){var t=this.pins.indexOf(e);t>-1&&this.pins.splice(t,1),push_undo_buffer()}generate_paths(e){this.undraw_paths(),this.paths=[];var t=1;e||(t=INACTIVE_OPACITY/this.num_lines());for(var s=0;s<this.line_spline_segments.length;s++){var i=this.line_spline_segments[s],a=2*this.lss_pos_color(i)-(this.num_lines_color()-1),n=this.generate_path(i,i.line.color_bg,a,TRACK_WIDTH,t);if(null!==n&&this.paths.push(n),DEBUG_BEZIER_CONTROLS)for(var r=0;r<i.spline_segments.length;r++)for(var o=i.spline_segments[r],l=0;l<o.controls.length;l++){var _="#000";l>0&&(_="#fff"),this.paths.push(L.circleMarker([o.controls[l].lat,o.controls[l].lng],{color:_,opacity:.75,fillColor:i.line.color_bg,fillOpacity:1,radius:4})),this.paths.push(L.polyline([[o.controls[l].lat,o.controls[l].lng],[o.centers[l].lat,o.centers[l].lng]],{color:"#aaa",opacity:.75}))}}}undraw_paths(){for(var e=0;e<this.paths.length;e++)this.layer.removeLayer(this.paths[e])}draw_paths(){for(var e=0;e<this.paths.length;e++)this.layer.addLayer(this.paths[e])}undraw_pins(){for(var e=0;e<this.pins.length;e++)this.pins[e].undraw()}get_pin_by_leaflet_id(e){for(var t=0;t<this.pins.length;t++)if(this.pins[t].marker._leaflet_id==e)return this.pins[t];return null}generate_pin_marker(e){var t=L.marker([e.location[0],e.location[1]],{draggable:!0,icon:PIN_ICON});t.id="pin-"+e.sid.toString(),e.marker=t;var s=this;return t.on("drag",function(e){s.get_pin_by_leaflet_id(e.target._leaflet_id).location=[e.latlng.lat,e.latlng.lng],s.draw_lines(),enmodal.transit_interface.dragging_pin=!0}),t.on("click",function(e){var t=s.get_pin_by_leaflet_id(e.target._leaflet_id);t.undraw(),s.remove_pin(t);for(var i=s.lines(),a=s.service==enmodal.transit_interface.active_service,n=0;n<i.length;n++){var r=i[n];enmodal.transit_interface.draw_line(r,!0,!0,s.layer,a,s.service)}s.draw_pins()}),t.on("dragend",function(e){enmodal.transit_interface.dragging_pin=!1,push_undo_buffer()}),t}draw_lines(){for(var e=this.lines(),t=this.service==enmodal.transit_interface.active_service,s=0;s<e.length;s++){var i=e[s];enmodal.transit_interface.draw_line(i,!0,!0,this.layer,t,this.service)}}draw_pins(){for(var e=0;e<this.pins.length;e++)this.pins[e].draw()}undraw(){this.undraw_paths(),this.undraw_pins()}draw(){try{this.draw_paths()}catch(e){console.log("Error drawing paths!"),console.log(this.sss)}}toJSON(){for(var e=[],t=0;t<this.stations.length;t++)e.push(this.stations[t].sid);var s=[];for(t=0;t<this.pins.length;t++)s.push(this.pins[t].toJSON());return{sid:this.sid,station_ids:e,pins:s}}}class Map{constructor(){this.sid=_id_factory.id(),this.services=[]}add_service(e){this.services.push(e)}primary_service(){return this.services[0]}get_service_by_id(e){for(var t=0;t<this.services.length;t++)if(this.services[t].sid==e)return this.services[t];return null}get_station_by_id(e){for(var t=0;t<this.services.length;t++){var s=this.services[t].get_station_by_id(e);if(null!==s)return s}return null}geographic_bounds(){for(var e=0,t=!1,s=0,i=!1,a=0,n=!1,r=0,o=!1,l=0,_=0;_<this.services.length;_++)for(var d=0;d<this.services[_].stations.length;d++){var c=this.services[_].stations[d];l+=1,(!t||c.location[0]<e)&&(e=c.location[0],t=!0),(!i||c.location[0]>s)&&(s=c.location[0],i=!0),(!n||c.location[1]<a)&&(a=c.location[1],n=!0),(!o||c.location[1]>r)&&(r=c.location[1],o=!0)}return 0===l?null:L.latLngBounds(L.latLng(e,a),L.latLng(s,r))}to_json(){return JSON.stringify(this)}from_json(e){this.sid=e.sid,this.services=[];for(var t=0;t<e.services.length;t++){var s=new Service(e.services[t].name);s.sid=e.services[t].sid,s.from_json(e.services[t]),this.add_service(s)}}}class Station{constructor(e,t,s){this.sid=void 0===s||!1===s?_id_factory.id():0,this.name=e,this.location=t,this.streets=[],this.neighborhood="",this.locality="",this.region="",this.ridership=-1}move_to(e,t){this.location=[e,t]}to_json(){return JSON.stringify(this)}from_json(e){this.sid=e.sid,this.name=e.name,this.location=[parseFloat(e.location[0]),parseFloat(e.location[1])],this.streets=e.streets,this.neighborhood=e.neighborhood,this.locality=e.locality,this.region=e.region}}class Stop{constructor(e,t){this.sid=void 0===t||!1===t?_id_factory.id():0,this.station=e}toJSON(){return{sid:this.sid,station_id:this.station.sid}}from_json(e,t){this.sid=e.sid,this.station=t.get_station_by_id(e.station_id),void 0===this.station&&console.log(e)}}class Line{constructor(e){this.sid=_id_factory.id(),this.name=e,this.full_name=e,this.color_bg="#000000",this.color_fg="#FFFFFF",this.group_id=0,this.stops=[],this.edges=[]}add_stop(e){this.stops.push(e)}remove_stop(e){var t=this.stops.indexOf(e);t>-1&&this.stops.splice(t,1)}has_stop(e){for(var t=0;t<this.stops.length;t++)if(this.stops[t].sid==e.sid)return!0;return!1}get_stop_by_id(e){for(var t=0;t<this.stops.length;t++)if(this.stops[t].sid==e)return this.stops[t];return null}get_stops_by_station(e){for(var t=[],s=0;s<this.stops.length;s++)this.stops[s].station.sid==e.sid&&t.push(this.stops[s]);return t}has_station(e){for(var t=0;t<this.stops.length;t++)if(this.stops[t].station.sid==e.sid)return!0;return!1}add_edge(e){this.edges.push(e)}remove_edge(e){var t=this.edges.indexOf(e);t>-1&&this.edges.splice(t,1)}has_edge(e){for(var t=0;t<this.edges.length;t++)if(this.edges[t].sid==e.sid)return!0;return!1}get_edge_by_id(e){for(var t=0;t<this.edges.length;t++)if(this.edges[t].sid==e)return this.edges[t];return null}get_edge_by_stops(e){for(var t=0;t<this.edges.length;t++)if(this.edges[t].compare_stops(e))return this.edges[t];return null}length(){for(var e=0,t=0;t<this.edges.length;t++)e+=this.edges[t].length();return e}neighbors(e){for(var t=[],s=0;s<this.edges.length;s++){var i=this.edges[s];i.stops[0].sid==e.sid&&t.push(i.stops[1]),i.stops[1].sid==e.sid&&t.push(i.stops[0])}return t}dijkstra(e){for(var t={},s={},i=0;i<this.stops.length;i++)t[this.stops[i].sid]=0,s[this.stops[i].sid]=0;for(t[e.sid]=0,s[e.sid]=1,i=0;i<this.stops.length;i++)for(var a=this.neighbors(this.stops[i]),n=0;n<a.length;n++){var r=t[this.stops[i].sid]+1;(r<t[a[n].sid]||!s[a[n].sid])&&(t[a[n].sid]=r,s[a[n].sid]=1)}return t}center_stop(){for(var e=-1,t=[],s=0;s<this.stops.length;s++){var i=this.stops[s],a=this.dijkstra(i),n=0;for(var r in a)n+=a[r];n<e||-1==e?(e=n,t=[i]):n==e&&t.push(i)}return t}outer_stops(){var e=[],t=[];if(0===this.stops.length)return[];if(1==this.stops.length)return[this.stops[0]];for(var s=0;s<this.edges.length;s++)for(var i=this.edges[s],a=0;a<i.stops.length;a++){var n=i.stops[a],r=e.indexOf(n),o=t.indexOf(n);-1==o&&-1==r&&e.push(n),-1==o&&r>-1&&(e.splice(r,1),t.push(n))}return 0===e.length?[this.stops[0]]:e}path_between_stops(e,t){function s(e,t,o){i.push(e),e==t&&(n=!0,a=i),r[e.sid]=1;for(var l=o.neighbors(e),_=0;_<l.length;_++){var d=l[_];r[d.sid]||n||s(d,t,o)}if(!n){var c=i.indexOf(e);i.splice(c,1)}}var i=[],a=[],n=!1,r={};return s(e,t,this),n}overlapping_stops(e){for(var t=0;t<this.stops.length;t++)if(e.station.sid==this.stops[t].station.sid)return this.stops[t];return null}remove_self_edges(){for(var e=[],t=0;t<this.edges.length;t++){var s=this.edges[t];s.stops[0].sid==s.stops[1].sid&&(e.push(s),this.remove_edge(s))}return e}remove_duplicate_edges(){for(var e=[],t=0;t<this.edges.length;t++)for(var s=this.edges[t],i=0;i<this.edges.length;i++){var a=this.edges[i];s!=a&&s.compare_stops(a.stops)&&-1==e.indexOf(s)&&e.push(s)}for(t=0;t<e.length;t++)this.remove_edge(e[t]);return e}toJSON(){for(var e=[],t=0;t<this.stops.length;t++)e.push(this.stops[t]);return{sid:this.sid,name:this.name,full_name:this.full_name,color_bg:this.color_bg,color_fg:this.color_fg,group_id:this.group_id,stops:e,edges:this.edges}}from_json(e,t){this.sid=e.sid,this.name=e.name,this.full_name=e.full_name,this.color_bg=e.color_bg,this.color_fg=e.color_fg,this.stops=[];for(var s=0;s<e.stops.length;s++){var i=new Stop(t.get_station_by_id(e.stops[s].station_id));i.sid=e.stops[s].sid,i.from_json(e.stops[s],t),this.add_stop(i)}for(this.edges=[],s=0;s<e.edges.length;s++){var a=new Edge([]);a.sid=e.edges[s].sid,a.from_json(e.edges[s],this),this.add_edge(a)}}}class Edge{constructor(e,t){this.sid=void 0===t||!1===t?_id_factory.id():0,this.stops=e,this.path=null}length(){var e=this.stops[0].station.location,t=this.stops[1].station.location,s=L.latLng(e[0],e[1]),i=L.latLng(t[0],t[1]);return s.distanceTo(i)}has_stop(e){return this.stops[0].sid==e.sid||this.stops[1].sid==e.sid}has_station(e){return this.stops[0].station.sid==e.sid||this.stops[1].station.sid==e.sid}compare_stops(e){return e[0].sid==this.stops[0].sid&&e[1].sid==this.stops[1].sid?1:e[0].sid==this.stops[1].sid&&e[1].sid==this.stops[0].sid?2:0}toJSON(){return{sid:this.sid,stop_ids:[this.stops[0].sid,this.stops[1].sid]}}from_json(e,t){this.sid=e.sid,this.stops=[];for(var s=0;s<e.stop_ids.length;s++)this.stops.push(t.get_stop_by_id(e.stop_ids[s]))}}class Transfer{constructor(e){this.sid=_id_factory.id(),this.stations=e}has_station(e){return this.stations.indexOf(e)>-1}toJSON(){return{sid:this.sid,station_ids:[this.stations[0].sid,this.stations[1].sid]}}from_json(e,t){this.sid=e.sid,this.stations=[];for(var s=0;s<e.station_ids.length;s++)this.stations.push(t.get_station_by_id(e.station_ids[s]))}}class Service{constructor(e){this.sid=_id_factory.id(),this.name=e,this.lines=[],this.stations=[],this.transfers=[],this.mode=""}add_line(e){this.lines.push(e)}get_line_by_id(e){for(var t=0;t<this.lines.length;t++)if(this.lines[t].sid==e)return this.lines[t];return null}get_line_by_stop(e){for(var t=0;t<this.lines.length;t++)if(this.lines[t].has_stop(e))return this.lines[t];return null}has_edge_for_stations(e,t){for(var s=0;s<this.lines.length;s++)for(var i=this.lines[s].get_stops_by_station(e),a=this.lines[s].get_stops_by_station(t),n=0;n<i.length;n++)for(var r=0;r<a.length;r++)if(null!==this.lines[s].get_edge_by_stops([i[n],a[r]]))return!0;return!1}add_station(e){this.stations.push(e)}get_station_by_id(e){for(var t=0;t<this.stations.length;t++)if(this.stations[t].sid==e)return this.stations[t];return null}station_lines(e){for(var t=[],s=0;s<this.lines.length;s++)for(var i=this.lines[s],a=0;a<i.stops.length;a++)i.stops[a].station.sid==e.sid&&-1==t.indexOf(i)&&t.push(i);return t}station_is_end_of_line(e){for(var t=this.station_lines(e),s=0;s<t.length;s++)for(var i=t[s].outer_stops(),a=0;a<i.length;a++)if(i[a].station==e)return!0;return!1}choose_drawmap(e,t,s){for(var i=0;i<e.length;i++){var a=e[i];if(a.line!=t){for(var n=!1,r=1;r<a.stops.length-1;r++)s[a.stops[r].station.sid]&&(n=!0);if(!n)return a}}return null}station_drawmap(e){function t(s,o,l,_){n[s.station.sid]=1,i[i.length-1].push(s.station),_+=1;for(var d=e.neighbors(s),c=0,p=((a=i[i.length-1])[a.length-2],a.length),h=0,m=0;m<d.length;m++){var u=d[m],v=e.get_edge_by_stops([s,u]);if(-1==r.indexOf(v.sid)){r.push(v.sid),c>0&&(i.push(a.slice(0,p)),h=0);var g=o.drawmaps(s,u,l),f=i[i.length-1],y=o.choose_drawmap(g,l,n);if(null!==y)for(var b=1;b<y.stops.length-1;b++)f.push(y.stops[b].station),_+=1;var T=t(u,o,l,h);_+=T,h+=T,c+=1}}return _}var s=e.outer_stops()[0],i=[[]],a=[],n={},r=[];null!==s&&t(s,this,e,0);for(var o=0;o<i.length;o++){var l=i[o],_=e.get_stops_by_station(l[0])[0],d=e.get_stops_by_station(l[l.length-1])[0],c=e.get_edge_by_stops([_,d]);if(null!==c&&-1==r.indexOf(c.sid)){for(var p=this.drawmaps(d,_,e),h={},m=0;m<l.length;m++)h[l[m].sid]=1;var u=this.choose_drawmap(p,e,h);if(null!==u)for(m=1;m<u.stops.length;m++)l.push(u.stops[m].station);else l.push(_.station)}}return i}drawmaps(e,t,s){function i(e,t,s,l){r[e.sid]=1,a[a.length-1].push(e),l+=1;for(var _=s.neighbors(e),d=0,c=((n=a[a.length-1])[n.length-2],n.length),p=0,h=0;h<_.length;h++){var m=_[h],u=s.get_edge_by_stops([e,m]);if(-1==o.indexOf(u.sid)){o.push(u.sid),d>0&&(a.push(n.slice(0,c)),p=0);var v=i(m,t,s,p);l+=v,p+=v,d+=1}}return l}for(var a=[[]],n=[],r={},o=[],l=this.station_lines(e.station),_=[new Drawmap(s,[e,t])],d=0;d<l.length;d++){var c=l[d];if(c.sid!=s.sid){var p=c.overlapping_stops(e),h=c.overlapping_stops(t);if(null!==p&&null!==h){r={};for(var m=0;m<c.stops.length;m++)r[c.stops[m].sid]=0;for(a=[[]],n=[],o=[],i(p,this,c,0),m=0;m<a.length;m++){var u=a[m],v=u.indexOf(h);-1!=v&&(u.length=v+1,_.push(new Drawmap(c,u)))}}}}var g={};for(d=0;d<_.length;d++){var f=_[d],y=f.line.sid;y in g?g[y]>f.stops.length&&(g[y]=f.stops.length):g[y]=f.stops.length}return _.sort(function(e,t){return e.line.sid!=t.line.sid?g[e.line.sid]<g[t.line.sid]:e.stops.length>t.stops.length}),_}add_transfer(e,t){for(var s=this.transfers.length-1;s>=0;s--){var i=this.transfers[s];i.has_station(e)&&i.has_station(t)&&this.transfers.splice(s,1)}e!=t&&this.transfers.push(new Transfer([e,t]))}remove_transfers_for_station(e){for(var t=0,s=this.transfers.length-1;s>=0;s--)this.transfers[s].has_station(e)&&(this.transfers.splice(s,1),t+=1);return t>0}remove_transfers_above_length(e){for(var t=0,s=this.transfers.length-1;s>=0;s--){var i=this.transfers[s];station_distance(i.stations[0],i.stations[1])>e&&(this.transfers.splice(s,1),t+=1)}return t>0}to_json(){return JSON.stringify(this)}from_json(e){this.sid=e.sid,this.name=e.name,this.mode=e.mode,this.stations=[];for(var t=0;t<e.stations.length;t++){var s=new Station(e.stations[t].name,e.stations[t].location);s.sid=e.stations[t].sid,s.from_json(e.stations[t]),this.add_station(s)}for(this.lines=[],t=0;t<e.lines.length;t++){var i=new Line(e.lines[t].name);i.sid=e.lines[t].sid,i.from_json(e.lines[t],this),this.add_line(i)}if(this.transfers=[],null!==e.transfers)for(t=0;t<e.transfers.length;t++){var a=new Transfer([]);a.from_json(e.transfers[t],this),this.transfers.push(a)}}}class Drawmap{constructor(e,t){this.line=e,this.stops=t}}class IdFactory{constructor(){this.current_id=0}id(){var e=this.current_id;return this.current_id+=1,e}}